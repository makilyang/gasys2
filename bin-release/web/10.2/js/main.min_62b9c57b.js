var __reflect=this&&this.__reflect||function(t,e,i){t.__class__=e,i?i.push(e):i=[e],t.__types__=t.__types__?i.concat(t.__types__):i},__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);i.prototype=e.prototype,t.prototype=new i},__awaiter=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(s,r){function o(t){try{h(n.next(t))}catch(e){r(e)}}function a(t){try{h(n["throw"](t))}catch(e){r(e)}}function h(t){t.done?s(t.value):new i(function(e){e(t.value)}).then(o,a)}h((n=n.apply(t,e||[])).next())})},__generator=this&&this.__generator||function(t,e){function i(t){return function(e){return n([t,e])}}function n(i){if(s)throw new TypeError("Generator is already executing.");for(;h;)try{if(s=1,r&&(o=r[2&i[0]?"return":i[0]?"throw":"next"])&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[0,o.value]),i[0]){case 0:case 1:o=i;break;case 4:return h.label++,{value:i[1],done:!1};case 5:h.label++,r=i[1],i=[0];continue;case 7:i=h.ops.pop(),h.trys.pop();continue;default:if(o=h.trys,!(o=o.length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){h=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){h.label=i[1];break}if(6===i[0]&&h.label<o[1]){h.label=o[1],o=i;break}if(o&&h.label<o[2]){h.label=o[2],h.ops.push(i);break}o[2]&&h.ops.pop(),h.trys.pop();continue}i=e.call(t,h)}catch(n){i=[6,n],r=0}finally{s=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}var s,r,o,a,h={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:i(0),"throw":i(1),"return":i(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a},DyEngine;!function(t){var e=function(){function t(){}return t.randomRangenumber=function(t,e){return Math.random()*(e-t)+t},t.equal=function(t,e,i){return void 0===i&&(i=1e-5),Math.abs(t-e)<=i},t.distance=function(t,e,i,n){var s=i-t,r=n-e;return Math.sqrt(s*s+r*r)},t.getnumberArr=function(t){for(var e=[],i=String(t),n=i.length-1;n>=0;n--){var s=Math.round(t/Math.pow(10,n));e.unshift(s),t%=Math.pow(10,n)}return e},t.getAngle=function(t,e,i,n,s){void 0===s&&(s=!0);var r=i-t,o=n-e,a=Math.atan2(o,r);return s&&(0>a?a=2*Math.PI+a:a>=2*Math.PI&&(a-=2*Math.PI)),a},t.calcVelocity=function(t,e,i,n){void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=1e4);var s;return 0!=e?t+=e*G.elapsed:0!=i&&(s=i*G.maxElapsed,t-s>0?t-=s:0>t+s?t+=s:t=0),0!=t&&1e4!=n&&(t>n?t=n:-n>t&&(t=-n)),t},t.toNumber=function(t,e){void 0===e&&(e=0);var i=Number(t);return isNaN(i)&&(i=e),i},t}();t.DyMath=e,__reflect(e.prototype,"DyEngine.DyMath")}(DyEngine||(DyEngine={}));var DyEngine;!function(t){var e=function(){function t(){this._callbacks={}}return t.prototype.on=function(t,e,i){(this._callbacks[t]=this._callbacks[t]||[]).push(e),this._sender=i},t.prototype.off=function(t,e){this.clean(t,e)},t.prototype.clean=function(t,e){if(0==arguments.length)return void(this._callbacks={});this._sender=null;var i=this._callbacks[t];if(i){if(t&&!e)return void delete this._callbacks[t];var n=this.index(i,e._off||e);~n&&i.splice(n,1)}},t.prototype.index=function(t,e){if([].indexOf)return t.indexOf(e);for(var i=0;i<t.length;++i)if(t[i]===e)return i;return-1},t.prototype.send=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];var n=[].slice.call(arguments,1),s=this._callbacks[t];if(s){s=s.slice(0);for(var r=0,o=s.length;o>r;++r)s[r].apply(this._sender,n)}return this},t}();t.DyEvent=e,__reflect(e.prototype,"DyEngine.DyEvent")}(DyEngine||(DyEngine={}));var DyEngine;!function(t){var e=egret.Point,i=t.DyMath,n=function(){function n(){this.angularAcceleration=0,this.angle=0,this.angularVelocity=0,this.angularDrag=0,this.maxAngular=1e4,this.moves=!0,this.dead=!1,this.active=!0,this.exists=!0,this.isGroup=!1,this.gravityEnable=!0,this.width=0,this.height=0,this._tag=0,this.visible=!0,this.parentGroup=null,this.typeDef=0,this.health=10,this.hpmax=10,this.faintTime=0,this.point=e.create(0,0),this.acceleration=e.create(0,0),this.velocity=e.create(0,0),this.drag=e.create(0,0),this.scale=e.create(1,1),this.scrollFactor=e.create(1,1),this.maxVelocity=e.create(1e4,1e4),this.exists=!0,this.animator=new t.DyAnimator,this.animator.uObj=this,this.gravityEnable=!1,this.events=new t.DyEvent}return Object.defineProperty(n.prototype,"tag",{get:function(){return this._tag},set:function(t){this._tag=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"x",{get:function(){return this.point.x},set:function(t){this.point.x=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"y",{get:function(){return this.point.y},set:function(t){this.point.y=t},enumerable:!0,configurable:!0}),n.prototype.update=function(){this.updateMotion(),this.faintTime=this.faintTime-2*G.elapsed;var t=this.buff;t&&t.update()},n.prototype.updateMotion=function(){var t;if(this.moves&&!(this.faintTime>0)){t=.5*(i.calcVelocity(this.angularVelocity,this.angularAcceleration,this.angularDrag,this.maxAngular)-this.angularVelocity),this.angularVelocity=this.angularVelocity+t,this.angle=this.angle+this.angularVelocity*G.maxElapsed,this.angularVelocity=this.angularVelocity+t,t=i.calcVelocity(this.velocity.x,this.acceleration.x,this.drag.x,this.maxVelocity.x);var e=t*G.maxElapsed,n=0;t=this.gravityEnable?.5*(i.calcVelocity(this.velocity.y,2461,this.drag.y,this.maxVelocity.y)-this.velocity.y):.5*(i.calcVelocity(this.velocity.y,0,this.drag.y,this.maxVelocity.y)-this.velocity.y),this.velocity.y=this.velocity.y+t,n=this.velocity.y*G.maxElapsed,this.point.x=this.point.x+e,this.point.y=this.point.y+n,this.animator&&(this.animator.x=this.point.x,this.animator.y=this.point.y,this.animator.rotation=this.angle,this.animator.scaleX=this.scale.x,this.animator.update()),this.Collider&&(this.Collider.x=this.point.x,this.Collider.y=this.point.y)}},n.prototype.hurt=function(t,e,i){this.health-=t,this.health<=0&&(this.dead=!0),this.lastHiter=i},n.prototype.addContact=function(t,e){},n.prototype.getScreenPosition=function(t,i){return void 0===t&&(t=null),void 0===i&&(i=0),null==t&&(t=new e),t.x=this.point.x+G.scroll.x*this.scrollFactor.x,t.y=this.point.y+G.scroll.y*this.scrollFactor.y,t},n.prototype.onScreen=function(){return this._scrpoint=this.getScreenPosition(this._scrpoint),this._scrpoint.x+this.width<0||this._scrpoint.x>G.width||this._scrpoint.y+this.height<0||this._scrpoint.y>G.height?!1:!0},n.prototype.reset=function(t,e){this.point.x=t,this.point.y=e,this.active=!0,this.exists=!0,this.dead=!1,this.animator&&(this.animator.x=t,this.animator.y=e,this.animator.rotation=this.angle,this.animator.update()),this.Collider&&(this.Collider.x=t,this.Collider.y=e)},n.prototype.render=function(){this.animator&&this.animator.render()},n.prototype.free=function(){this.animator&&this.animator.parent.removeChild(this.animator),this.exists=!1},n.prototype.kill=function(){this.exists=!1,this.animator&&this.animator.kill()},n}();t.DyObject=n,__reflect(n.prototype,"DyEngine.DyObject")}(DyEngine||(DyEngine={}));var gobjs;!function(t){var e=function(t){function e(){var e=t.call(this)||this;return e._elpased=0,e}return __extends(e,t),e.prototype.create=function(){this.animator.addAnimation("def",G.getCommonMovieClip("eBase")),this.animator.switchAnimation("def",!0),this.animator.touchEnabled=!0,this._elpased=0},e.make=function(t,i){var n=new e;return n.create(),n.x=t,n.y=i,n},e.prototype.startBuild=function(){if(null==this._bar){var t=utils.BuildBar.make(this,0,0);this._bar=t,this.busying=!0}},e.prototype.update=function(){if(this.busying){this._elpased+=2*G.elapsed;var e=this._bar;e&&e.update(this._elpased,1),this._elpased>1&&(this.busying=!1,this._elpased=0,this._bar.kill(),this._bar=null,this.events.send("build",this))}t.prototype.update.call(this)},e}(DyEngine.DyObject);t.eBase=e,__reflect(e.prototype,"gobjs.eBase")}(gobjs||(gobjs={}));var gobjs;!function(t){var e=DyEngine.DyMath,i=DyEngine.DyEvent,n=function(n){function s(){var t=n.call(this)||this;return t.dh=1,t._currentPath=0,t.inAir=!1,t.speed=10,t.headx=0,t.heady=1,t.fotx=0,t.foty=0,t.gold=0,t.dieEvent=new i,t}return __extends(s,n),s.prototype.create=function(){this.clip||(this.clip=G.getUnitClip(this.entry)),this.animator.addAnimation("walk",this.clip),this.animator.switchAnimation("walk",!0),this.animator.gotoAndPlay(1),this.animator.touchEnabled=!1,this.animator.x=this.x,this.animator.y=this.y,this.Collider||(this.Collider=DyEngine.DyShape.make(this,0,0,1,0,0)),this.Collider.interestDist=1,this.Collider.contactEvent.on("collision",this.addContact,this),G.phys.addShape(this.Collider),this._shadow||(this._shadow=t.EffectShadow.make(0,0,0)),this.animator.addChildAt(this._shadow,0),this.health=this.hpmax,this._currentPath=0,this.exists=!0,this.dead=!1},s.make=function(t,e,i,n){var r=s.getAvail(t);null==r&&(r=new s,s.members.push(r));var o=D.creeps[t];return r.entry=t,r.typeDef=o.dt,r.inAir=2==o.bt,r.speed=o.spd,r.hpmax=n,r.x=e,r.y=i,r.create(),r},s.prototype.kill=function(){if(this.exists){if(n.prototype.kill.call(this),this._bar&&(this._bar.kill(),this._bar=null),this._shadow&&(this._shadow.kill(),this._shadow=null),G.sWorld.removeFromLayer(core.GameWorld.LAYER_OBJECTS,this),this.Collider.contactEvent.clean(),G.phys.removeShape(this.Collider),this.health<=0){this.dieEvent.send("ondie",this,this.lastHiter);var e=this.lastHiter;utils.EffectFlash.make("common","ghost",this.x,this.y);e&&e instanceof t.eTower&&e.extargold>0&&utils.EffectFlash.make("common","gold",this.x,this.y)}else this.dieEvent.send("onrun",this);this.animator.stop(),this.dieEvent.clean()}},s.prototype.free=function(){this.kill(),this.Collider=null,this.clip=null},s.prototype.hurt=function(t,e,i){n.prototype.hurt.call(this,t,e,i),this._bar||(this._bar=utils.EffectBar.make(this,0,0))},s.prototype.update=function(){if(n.prototype.update.call(this),this.dead)return void this.kill();this._bar&&this._bar.update();var t=this._currentPath,i=this.path[t],s=this.x,r=this.y;if(e.equal(i.x,s,5)&&e.equal(i.y,r,5))if(t++,t<this.path.length){i=this.path[t];var o=this.speed,a=e.getAngle(s,r,i.x,i.y);this.velocity.x=Math.cos(a)*o,this.velocity.y=Math.sin(a)*o,this._currentPath=t,this.velocity.x>0?this.scale.x=-1:this.scale.x=1}else this.dead=!0,G.sWorld.hurt(this.dh)},s.getAvail=function(t){for(var e,i=s.members.length,n=0;i>n;){if(e=s.members[n],null!=e&&!e.exists&&e.entry==t)return e;n++}return null},s.destory=function(){for(var t,e=s.members.length,i=0;e>i;)t=s.members[i],null!=t&&t.free(),i++;s.members.length=0},s.members=[],s}(DyEngine.DyObject);t.BasicUnit=n,__reflect(n.prototype,"gobjs.BasicUnit")}(gobjs||(gobjs={}));var gobjs;!function(t){var e=function(t){function e(){var e=t.call(this)||this;return e._acc=2,e}return __extends(e,t),e.prototype.create=function(t,e){this.animator.addAnimation("def",G.getCommonMovieClip("eHome")),this.animator.switchAnimation("def",!0),this.x=t,this.y=e,this._oriy=this.y,this.velocity.y=12},e.make=function(t,i){var n=new e;return n.create(t,i),n},e.prototype.update=function(){t.prototype.update.call(this),this.y>this._oriy+10?this.velocity.y=-8:this.y<this._oriy-10&&(this.velocity.y=8)},e}(DyEngine.DyObject);t.eHome=e,__reflect(e.prototype,"gobjs.eHome")}(gobjs||(gobjs={}));var BaseScene=function(){function t(){}return t.prototype.initialize=function(){this._initialized=!0},t.prototype.show=function(t,e){void 0===t&&(t=null),void 0===e&&(e=null),this.initialize(),this._cb=t,this.doCallback()},t.prototype.hide=function(t){void 0===t&&(t=null),this._cb=t,this.doCallback()},t.prototype.free=function(){this._initialized=!1},t.prototype.doCallback=function(){null!=this._cb&&(this._cb.apply(this),this._cb=null)},t}();__reflect(BaseScene.prototype,"BaseScene");var core;!function(t){var e=DyEngine.DyMath,i=gobjs.BasicUnit,n=gobjs.eHome,s=gobjs.eBase,r=function(r){function o(){var t=r.call(this)||this;return t._elpased=0,t._prevAltitude=0,t._dist=3e3,t._jumptimes=0,t.waveArray=[],t.pauseInterval=0,t._waiting=!0,t._actUI=[],t._taskzero=!1,t._creeps=0,t.elpased=0,t.cd1=0,t.cd2=0,t.started=!1,t._last=0,t._tickers=[],t._senders=[],t.cursk=0,t._gameObjects=[],t._foreObjects=[],t.eventUpdate=new DyEngine.DyEvent,t._tm=new DyEngine.DyTaskManager,t}return __extends(o,r),o.prototype.create=function(){var t=this;G.sWorld=this,this._bg=new egret.Bitmap;var e=RES.getRes(this.config.bg);this._bg.texture=e,this._bg.y=0,this._bg.width=G.width,this._bg.height=G.height,this.addChild(this._bg),this._bgContainer=new egret.DisplayObjectContainer,this.addChild(this._bgContainer),this._background=new egret.DisplayObjectContainer,this.addChild(this._background),this._objectsLayer=new egret.DisplayObjectContainer,this.addChild(this._objectsLayer),this._foreLayer=new egret.DisplayObjectContainer,this.addChild(this._foreLayer);var i,r=this.config.tdb,a=0;for(a;a<r.length;a++){i=r[a];var h=s.make(i.x,i.y);this.addToLayer(o.LAYER_OBJECTS,h)}this.home=n.make(this.config.home.x,this.config.home.y),2==G.gLevel?this.home.hpmax=5:1==G.gLevel?this.home.hpmax=10:this.home.hpmax=20,this.home.health=this.home.hpmax,this.addToLayer(o.LAYER_FRONTS,this.home);var l,c=this.config.data;for(a=0;a<c.length;a++)l=c[a],this._tm.addTask(this.beforeWave,[l.cfg,a],this),this._tm.addTask(this.waitNextWave,[],this),this._tm.addTask(this.afterWait,[a],this),this._tm.addTask(this.respawnEnemy,[l.list],this),this._tm.waitChilds(),this._tm.addPause(5);this._tm.onComplete=function(){egret.log("task complete!",t),t._taskzero=!0};var u=DyEngine.Engine.getInstance();u.stage.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onTouch,this),u.stage.addEventListener(egret.TouchEvent.TOUCH_MOVE,this.onMove,this),u.stage.addEventListener(egret.TouchEvent.TOUCH_END,this.onEnd,this)},o.prototype.beforeWave=function(t,e){var i,n;for(i=0;i<t.length;i++){n=t[i];var s=gui.WaveAction.make(n.t,n.x,n.y);s.pth=i,s.setSec(G.DELAY),this._actUI.push(s)}return!0},o.prototype.waitNextWave=function(){if(!this.started)return!1;var t=this.pauseInterval;t+=2*G.elapsed,this.pauseInterval=t;var e,i=this._actUI,n=Math.ceil(G.DELAY-t);for(0>n&&(n=0),e=0;e<i.length;e++){var s=i[e];s.setSec(n)}return t>=G.DELAY?(this.pauseInterval=0,!0):!1},o.prototype.afterWait=function(t){var e,i=this._actUI;for(e=0;e<i.length;e++){var n=i[e];n.close()}return observer.UIManager.send("upd_wave",t+1),!0},o.prototype.respawnEnemy=function(t){var i,n,s,r,o=t.length;for(i=0;o>i;i++){r=t[i];var a=new DyEngine.DyTaskManager;for(this._tm.addChild(a),n=0;n<r.length;n++){var h=r[n],l=h.count;if("pause"==h.id)a.addPause(l);else{var c=e.toNumber(h.dh,1);for(s=0;l>s;s++)a.addTask(this.addEnemy,[h.id,h.hp,i,h.gold,c],this,!1),a.addPause(h.period)}}}return!0},o.prototype.addEnemy=function(t,e,n,s,r){var a=this;void 0===s&&(s=0),void 0===r&&(r=1);var h=this.config.path[n],l=i.make(t,h[0].x,h[0].y,e);return 2==G.gLevel?e=2*e:1==G.gLevel&&(e=Math.round(1.5*e)),l.path=h,l.gold=s,l.dh=r,this._creeps++,l.dieEvent.on("ondie",function(t,e){a._creeps--;var i=G.gold+t.gold;e instanceof gobjs.eTower&&(i+=Number(e.extargold)),G.gold=i,observer.UIManager.send("upd_gold")},this),l.dieEvent.on("onrun",function(t){a._creeps--},this),this.addToLayer(o.LAYER_OBJECTS,l),!0},o.prototype.hurt=function(t){this.home.health-=t,this.home.health<0&&(this.home.health=0),observer.UIManager.send("hurt_home",this.home.health),0==this.home.health&&(DyEngine.Engine.getInstance().stop(),gui.GameEnd.make(1))},o.prototype.onDie=function(){},o.prototype.onTouch=function(t){},o.prototype.onMove=function(t){},o.prototype.onLabel=function(t,e){e=e.substr(0,e.length-1),"snd"==t&&G.onceSnd(e)},o.prototype.hitRange=function(e,n,s,r,o){var a,h,l=G.phys.query(n,s,r);for(a=0;a<l.length;a++)if(l[a]instanceof i)if(h=l[a],h.hurt(e,0,null),"sk1"==o){var c=t.Buff.make(h,"sk1");c.duration=4,c.hurt=2,c.period=1,c.create(),h.buff=c}else if("sk2"==o){var c=t.Buff.make(h,"sk2");c.duration=3,c.faint=3,c.create(),h.buff=c}},o.prototype.onEnd=function(t){var e=this;if(!(t.target instanceof fairygui.GProgressBar)){var i=t.stageX+t.stageX*(1-G.scale),n=t.stageY+t.stageY*(1-G.scale);if(this.cursk>0){if(1==this.cursk){if(this.cd1>0)return;var r=utils.EffectFlash.make("common","sk1",i,n);r.type=1,this.cd1=5,r.events.on("onlab",this.onLabel,r),r.events.on("end",function(t){e.hitRange(10,i,n,70,"sk1"),r.events.off(),e._rMark1&&(e._rMark1.kill(),e._rMark1=null)},r),this._rMark1=gobjs.EffectShadow.make(1,i,n,70),this._bgContainer.addChild(this._rMark1)}if(2==this.cursk){if(this.cd2>0)return;var o=utils.EffectFlash.make("common","sk2",i,n);o.type=1,this.cd2=15,o.events.on("onlab",this.onLabel,o),o.events.on("end",function(t){e.hitRange(0,i,n,70,"sk2"),e._rMark2&&(e._rMark2.kill(),e._rMark2=null)},o),this._rMark2=gobjs.EffectShadow.make(1,i,n,70),this._bgContainer.addChild(this._rMark2)}observer.UIManager.send("casted")}else{if(t.target instanceof fairygui.GButton)return;if(t.target instanceof DyEngine.DyAnimator){var a=t.target;if(a.uObj instanceof s){var h=a.uObj;if(h.busying)return;return void gui.BuildMenu.show(h,h.x,h.y)}if(a.uObj instanceof gobjs.eTower){var h=a.uObj;if(h.busying)return;return void gui.BuildMenu.show(h,h.x,h.y)}}else gui.BuildMenu.hide()}}},o.prototype.addToLayer=function(t,e){switch(t){case o.LAYER_OBJECTS:this.addGameObject(this._gameObjects,e),this._objectsLayer.addChild(e.animator);break;case o.LAYER_FRONTS:this.addGameObject(this._foreObjects,e),this._foreLayer.addChild(e.animator)}},o.prototype.removeFromLayer=function(t,e){if(null!=e){var i;switch(t){case o.LAYER_OBJECTS:i=this._gameObjects;break;case o.LAYER_FRONTS:i=this._foreObjects}this.removeGameObject(i,e),this._objectsLayer.removeChild(e.animator)}},o.prototype.addGameObject=function(t,e){if(-1==t.indexOf(e)){var i,n;for(i=0;i<t.length;i++)if(n=t[i],null==n)return void(t[i]=e);t.push(e)}},o.prototype.removeGameObject=function(t,e){var i=t.indexOf(e);-1!=i&&(t[i]=null)},o.prototype.update=function(){this.elpased+=2*G.elapsed,this.cd1-=2*G.elapsed,this.cd2-=2*G.elapsed,this.elpased-this._last>=1&&(this._last=this.elpased,observer.UIManager.send("elpased",this._last));var t,e,i,n=this._objectsLayer,s=this._gameObjects;for(t=0;t<s.length;t++)if(e=s[t]){null==i&&(i=e);var r=n.getChildIndex(e.animator),o=n.getChildIndex(i.animator);-1!=r&&-1!=o&&(e.y>i.y&&o>r||e.y<i.y&&r>o)&&(n.swapChildren(e.animator,i.animator),i=e),e.update()}for(s=this._foreObjects,t=0;t<s.length;t++)e=s[t],e&&(e.update(),e.dead&&(e.kill(),s[t]=null));s=this._tickers;var a,h,l=this._senders;for(t=0;t<s.length;t++)a=s[t],h=l[t],a&&a.apply(h);this._tm.isRunning&&this._tm.update(),G.phys.update(),this._taskzero&&this._creeps<=0&&this.home.health>0&&(DyEngine.Engine.getInstance().stop(),gui.GameEnd.make(0))},o.prototype.addTicker=function(t,e){-1==this._tickers.indexOf(t)&&(this._tickers.push(t),this._senders.push(e))},o.prototype.cast=function(t){if(1==t){if(this.cd1>0)return;this.cd1=15}else if(2==t){if(this.cd2>0)return;this.cd2=0}},o.prototype.clear=function(){G.gold=0;var t=DyEngine.Engine.getInstance();t.stage.removeEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onTouch,this),t.stage.removeEventListener(egret.TouchEvent.TOUCH_MOVE,this.onMove,this),t.stage.removeEventListener(egret.TouchEvent.TOUCH_END,this.onEnd,this),this.eventUpdate.clean(),this._tm.clear();var e,i=this._actUI;for(e=0;e<i.length;e++){var n=i[e];n.close()}var s,r=this._gameObjects;for(e=0;e<r.length;e++)s=r[e],s&&s.kill();this._gameObjects=[],this._foreObjects=[],this.parent&&this.parent.removeChild(this),gobjs.BasicUnit.destory(),gobjs.Bullet.destory()},o.LAYER_OBJECTS=1,o.LAYER_FRONTS=2,o}(egret.DisplayObjectContainer);t.GameWorld=r,__reflect(r.prototype,"core.GameWorld")}(core||(core={}));var DyEngine;!function(t){var e=function(t){function e(){return t.call(this)||this}return __extends(e,t),e}(t.DyObject);t.BasicObject=e,__reflect(e.prototype,"DyEngine.BasicObject")}(DyEngine||(DyEngine={}));var DyEngine;!function(t){var e=function(t){function e(){var e=t.call(this)||this;return e._lastAngle=0,e.allowRotation=!1,e._lastPosition=new egret.Point,e.members=[],e.isGroup=!0,e}return __extends(e,t),Object.defineProperty(e.prototype,"size",{get:function(){return this.members.length},enumerable:!0,configurable:!0}),e.prototype.remove=function(t,e){void 0===e&&(e=!1);var i=this.members.indexOf(t);return i>-1&&(this.members[i]=null,e&&this.members.splice(i,1)),t},e.prototype.getObjectsByTag=function(t,e){void 0===e&&(e=null);var i;null==e&&(e=[]);for(var n,s=this.members.length;s>n;)i=this.members[n],null!=i&&i.tag==t&&(e[e.length]=i),n++;return e},e.prototype.update=function(){this.updateMotion(),this.updateMembers(),this.allowRotation&&this.rotateMembers(),this.saveOldPos()},e.prototype.numDead=function(){for(var t,e,i,n=this.members.length;n>i;)t=this.members[i],null!=t&&t.dead&&e++,i++;return e},e.prototype.rectQuery=function(t,e,i,n,s){void 0===s&&(s=null);var r;null==s&&(s=[]);for(var o,a=this.members.length;a>o;)r=this.members[o],null!=r&&r.exists&&r.x>t&&r.x<i&&r.y>e&&r.y<n&&(s[s.length]=r),o++;return s},e.prototype.clearMembers=function(){for(var t,e=this.members.length;e>t;)this.members[t]=null,t++;this.members.length=0},e.prototype.getByTag=function(t){for(var e,i,n=this.members.length;n>i;){if(e=this.members[i],null!=e&&e.tag==t)return e;++i}return null},e.prototype.numLiving=function(){for(var t,e,i,n=this.members.length;n>i;)t=this.members[i],null!=t&&t.exists&&!t.dead&&e++,i++;return e},e.prototype.updateMembers=function(){var t,e,i,n;(this.x!=this._lastPosition.x||this.y!=this._lastPosition.y)&&(n=!0,t=this.x-this._lastPosition.x,e=this.y-this._lastPosition.y);var s=this.members.length,r=0;for(r;s>r;++r)i=this.members[r],null!=i&&i.exists&&(n&&(i.isGroup?i.reset(i.x+t,i.y+e):(i.x=i.x+t,i.y=i.y+e)),i.active&&i.update())},e.prototype.numOnScreen=function(){for(var t,e,i,n=this.members.length;n>i;)t=this.members[i],null!=t&&t.exists&&t.onScreen()&&e++,i++;return e},e.prototype.swap=function(t,e){var i=this.members.indexOf(t),n=this.members.indexOf(e);return i>-1&&n>-1?(this.members[i]=e,this.members[n]=t,!0):!1},e.prototype.render=function(){for(var t,e,i=this.members.length;i>e;)t=this.members[e],null!=t&&t.exists&&t.visible&&t.render(),e++},e.prototype.getAlive=function(t){void 0===t&&(t=0);for(var e,i,n=this.members.length;n>i;){if(e=this.members[i],null!=e&&e.exists&&!e.dead&&e.tag==t)return e;i++}return null},e.prototype.getCount=function(t){void 0===t&&(t=0);for(var e,i,n,s=this.members.length;s>i;)e=this.members[i],null!=e&&e.tag==t&&n++,i++;return n},e.prototype.getDead=function(){for(var t,e,i=this.members.length;i>e;){if(t=this.members[e],null!=t&&t.dead)return t;e++}return null},e.prototype.getExtant=function(t){void 0===t&&(t=0);for(var e,i,n=this.members.length;n>i;){if(e=this.members[i],null!=e&&e.tag==t)return e;i++}return null},e.prototype.contains=function(t){return this.members.indexOf(t)>-1?!0:!1},e.prototype.rotateMembers=function(){var t,e,i,n,s;if(this.angle!=this._lastAngle)for(t=this.angle-this._lastAngle,e=new egret.Point,n=this.members.length,s=0;n>s;)i=this.members[s],null!=i&&i.exists&&(i.isGroup||(i.x=e.x,i.y=e.y,i.angle=i.angle+t)),s++},e.prototype.add=function(t,e){void 0===e&&(e=!0);var i,n;if(e)for(i=this.members.length,n=0;i>n;){if(null==this.members[n])return this.members[n]=t,t;n++}return this.members[this.members.length]=t,t},e.prototype.saveOldPos=function(){this._lastPosition.x=this.x,this._lastPosition.y=this.y,this._lastAngle=this.angle},e.prototype.kill=function(){for(var e,i,n=this.members.length;n>i;)e=this.members[i],null!=e&&e.exists&&e.kill(),i++;t.prototype.kill.call(this)},e.prototype.free=function(){for(var e,i,n=this.members.length;n>i;)e=this.members[i],null!=e&&(e.parentGroup=null,e.free()),i++;this.clearMembers(),t.prototype.free.call(this)},e.prototype.resetRotation=function(t){void 0===t&&(t=0);var e,i,n,s,r=new egret.Point;if(t!=this._lastAngle){for(e=t-this._lastAngle,n=this.members.length,s=0;n>s;)i=this.members[s],null!=i&&i.exists&&(i.isGroup||(i.x=r.x,i.y=r.y,i.angle=i.angle+e)),s++;this.saveOldPos()}},e.prototype.reset=function(e,i){var n,s,r;if(t.prototype.reset.call(this,e,i),this.x!=this._lastPosition.x||this.y!=this._lastPosition.y){n=this.x-this._lastPosition.x,s=this.y-this._lastPosition.y;for(var o,a=this.members.length;a>o;)r=this.members[o],null!=r&&r.exists&&(r.isGroup?r.reset(r.x+n,r.y+s):(r.x=r.x+n,r.y=r.y+s)),o++;this.saveOldPos()}},e.prototype.replace=function(t,e){var i=this.members.indexOf(t);return i>-1?(this.members[i]=e,!0):!1},e.prototype.getAvail=function(t){void 0===t&&(t=0);for(var e,i,n=this.members.length;n>i;){if(e=this.members[i],null!=e&&!e.exists&&e.tag==t)return e;i++}return null},e.prototype.order=function(){},e}(t.DyObject);t.DyGroup=e,__reflect(e.prototype,"DyEngine.DyGroup")}(DyEngine||(DyEngine={}));var G=function(){function t(){}return t.init=function(e,i,n,s){this.director=new Director,this.scroll=new egret.Point,this.width=e,this.height=i,this.widthHalf=.5*e,this.heightHalf=.5*i;var r=n/e,o=s/i;o>r?this.scale=r:this.scale=o,this.gold=500,this.uimgr=observer.UIManager.getInstance(),this.phys=new DyEngine.DyPhysics;var a=egret.localStorage.getItem(t.SAVEKEY);a&&(this.sd=JSON.parse(a)),egret.log("screen size:",e+"x"+i,"Scale:"+this.scale),null==this.sd&&(this.sd={ddb:0,star:0,rec:{},shop:[],tal:{},score:0,tt:0,tm:0});var h=new Date(DyEngine.DyMath.toNumber(this.sd.tm)),l=new Date;h.getDate()!=l.getDate()&&h.getMonth()!=l.getMonth()&&(this.sd.tm=l.getTime(),this.sd.tt=0),this.gLevel=0},t.getCommonMovieClip=function(e){if(null==t._mcDataFactory){var i=RES.getRes("common_png"),n=RES.getRes("common_json"),s=new egret.MovieClipDataFactory(n,i);t._mcDataFactory=s}var r=new egret.MovieClip(t._mcDataFactory.generateMovieClipData(e));return r},t.initTowerFactory=function(){if(null==t._towerDataFactory){var e=RES.getRes("ta_png"),i=RES.getRes("ta_json"),n=new egret.MovieClipDataFactory(i,e);t._towerDataFactory=n}},t.getTowerClip=function(e){if(null==t._towerDataFactory)return null;var i=new egret.MovieClip(t._towerDataFactory.generateMovieClipData(e));return i},t.getUnitClip=function(t){if(null==this._unitDataFactory){var e=RES.getRes("guai_png"),i=RES.getRes("guai_json"),n=new egret.MovieClipDataFactory(i,e);this._unitDataFactory=n}var s=new egret.MovieClip(this._unitDataFactory.generateMovieClipData(t));return s},t.str_pad=function(t,e,i,n){void 0===n&&(n="left");var s=t.length,r=e-s,o=0;for(o;r>o;o++)t=i+t;return t},t.talent=function(t){var e=this.sd.tal,i=DyEngine.DyMath.toNumber(e[t]);return i},t.onceSnd=function(t){var e=new egret.Sound;e.once(egret.Event.COMPLETE,function(t){e.play(0,1)},this),e.load("resource/snd/"+t+".mp3")},t.SAVEKEY="YSfyz24399_2",t.DELAY=30,t.elapsed=.02,t.timeScale=.5,t.gLevel=0,t.maxElapsed=.0333333,t.buffDelay=0,t.gold=0,t.isMobile=!1,t.SHOP={zs002:{g:100},zs003:{req:"zs002",g:200},zs004:{req:"zs003",g:300},zs005:{req:"zs004",g:400},yx002:{g:100},yx003:{req:"yx002",g:200},yx004:{req:"yx003",g:300},yx005:{req:"yx004",g:400},ck002:{g:100},ck003:{req:"ck002",g:200},ck004:{req:"ck003",g:300},ck005:{req:"ck004",g:400},fs002:{g:100},fs003:{req:"fs002",g:200},fs004:{req:"fs003",g:300},fs005:{req:"fs004",g:400}},t.TALENT={zs0:{req:0,g:1,title:"增加伤害"},zs1:{req:1,title:"增加范围",g:2},zs2:{req:2,title:"增加速度",g:3},zs3:{req:3,title:"减少造价",g:4},yx0:{req:0,g:1,title:"增加伤害"},yx1:{req:1,title:"增加范围",g:2},yx2:{req:2,title:"增加速度",g:3},yx3:{req:3,title:"减少造价",g:4},ck0:{req:0,g:1,title:"增加伤害"},ck1:{req:1,title:"增加范围",g:2},ck2:{req:2,title:"增加速度",g:3},ck3:{req:3,title:"减少造价",g:4},fs0:{req:0,g:1,title:"增加伤害"},fs1:{req:1,title:"增加范围",g:2},fs2:{req:2,title:"增加速度",g:3},fs3:{req:3,title:"减少造价",g:4}},t}();__reflect(G.prototype,"G");var DebugPlatform=function(){function t(){}return t.prototype.getUserInfo=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,{nickName:"username"}]})})},t.prototype.login=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2]})})},t}();__reflect(DebugPlatform.prototype,"DebugPlatform",["Platform"]),window.platform||(window.platform=new DebugPlatform);var core;!function(t){var e=function(t){function e(){var e=t.call(this)||this;return e.maxAltitude=0,e.animator=new DyEngine.DyAnimator,e.dieEvent=new DyEngine.DyEvent,e}return __extends(e,t),e.prototype.setFly=function(){if(null==this.wingClip){this.wingClip=new DyEngine.DyAnimator;var t=RES.getRes("avatar_png"),e=RES.getRes("avatar_json"),i=new egret.MovieClipDataFactory(e,t);this.wingClip.addAnimation("def",new egret.MovieClip(i.generateMovieClipData("bigwing"))),this.wingClip.switchAnimation("def",!0),this.wingClip.x=0,this.wingClip.y=0}this.animator.addChildAt(this.wingClip,0),this.wingClip.gotoAndStop(1),this.isfly=!0,this.animator.switchAnimation("jump",!0)},e.prototype.stopFly=function(){this.animator.removeChild(this.wingClip),this.isfly=!1},e.prototype.jump=function(t){this.animator.switchAnimation("jump",!1),this.animator.gotoAndPlay(1,1),this.velocity.y=t},e.prototype.update=function(){t.prototype.update.call(this),this.onFloor?"idle"!=this.animator.currentAnimationKey&&(this.animator.switchAnimation("idle",!1),this.animator.gotoAndPlay(1,-1),this.jumped=!1):this.velocity.y>0&&"fall"!=this.animator.currentAnimationKey&&(this.animator.switchAnimation("fall",!1),this.animator.gotoAndPlay(1,1)),this.x<0?this.x=0:this.x>G.width&&(this.x=G.width),this.maxAltitude<-this.y&&(this.maxAltitude=-this.y),this.isfly&&(this.velocity.y=-1200)},e}(DyEngine.BasicObject);t.Player=e,__reflect(e.prototype,"core.Player")}(core||(core={}));var LoadingUI=function(t){function e(e,i){var n=t.call(this)||this;return n._w=e,n._h=i,n.createView(),n}return __extends(e,t),e.prototype.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=this._w,this.textField.height=100,this.textField.textAlign="center",this.h5api=window.h5api},e.prototype.onProgress=function(t,e){this.textField.text="Loading..."+t+"/"+e,this.h5api.progress(t/e*100)},e}(egret.Sprite);__reflect(LoadingUI.prototype,"LoadingUI",["RES.PromiseTaskReporter"]);var DyEngine;!function(t){var e=function(e){function i(){var i=e.call(this)||this;return i._animations={},i._images={},i.frameEvent=new t.DyEvent,i}return __extends(i,e),i.prototype.render=function(){},i.prototype.addImage=function(t,e){var i=this._images[t];null==i&&(i=new egret.Bitmap,this._images[t]=i,this.addChild(i)),i.texture=e},i.prototype.removeImage=function(t){var e=this._images[t];null!=e&&(this._images[t]=null,this.removeChild(e))},i.prototype.addAnimation=function(t,e){this._animations[t]=e},i.prototype.switchAnimation=function(t,e){if(void 0===e&&(e=!1),this.currentAnimationKey!=t||e){var i=this._animations[t];this._currentAnimation&&this.removeChild(this._currentAnimation),this._currentAnimation=i,this._currentAnimation&&(this.currentAnimationKey=t,this.addChild(i),i.play())}},i.prototype.gotoAndPlay=function(t,e){void 0===e&&(e=-1),this._currentAnimation&&this._currentAnimation.gotoAndPlay(t,e)},i.prototype.gotoAndStop=function(t,e){void 0===e&&(e=-1),this._currentAnimation&&this._currentAnimation.gotoAndStop(t)},i.prototype.play=function(){this._currentAnimation&&this._currentAnimation.play(-1)},i.prototype.stop=function(){this._currentAnimation&&this._currentAnimation.stop()},i.prototype.update=function(){var t,e=this._currentAnimation;if(e&&(t=e.currentFrameLabel,e.currentFrame==e.totalFrames&&this.frameEvent.send("onend")),t)for(var i=void 0,n=void 0,s=void 0,r=void 0,o=t.split(";"),a=0;a<o.length;a++)i=o[a],n=i.indexOf(":"),r=i.substr(0,n),s=i.substr(n+1),this.frameEvent.send("onlab",r,s)},i.prototype.kill=function(){this._currentAnimation&&this._currentAnimation.stop();var t,e=this._animations;for(var i in e)t=e[i],t&&t.stop();this._currentAnimation=null,this._animations={},this._images={},this.uObj=null},i}(egret.DisplayObjectContainer);t.DyAnimator=e,__reflect(e.prototype,"DyEngine.DyAnimator")}(DyEngine||(DyEngine={}));var core;!function(t){var e=function(){function t(){this.duration=0,this.period=1,this.hurt=0,this.faint=0,this.dead=!1,this._period=0
}return t.make=function(e,i){var n=new t;return n.entry=i,n.target=e,n},t.prototype.create=function(){this._period=this.period,this.target&&(this.target.faintTime=this.faint)},t.prototype.update=function(){if(null==this.target||this.dead)return this.dead=!0,void(this.target&&this.target.buff&&(this.target.buff=null));var t=this.duration,e=this._period;t-=2*G.elapsed,this.duration=t,e-=2*G.elapsed,this._period=e,0>t?this.dead=!0:0>e&&(this._period=this.period,this.hurt>0&&(this.target.hurt(this.hurt,0,null),utils.EffectDmg.make(this.target,this.hurt)))},t}();t.Buff=e,__reflect(e.prototype,"core.Buff")}(core||(core={}));var core;!function(t){var e=function(){function t(){this.offset=0,this._arenaWidth=Number.MAX_VALUE,this._areaHeight=Number.MAX_VALUE}return t.prototype.update=function(){if(!this.pause&&null!=this._target){if(null==this._target)return;var t=this._target.velocity;this._speedX=(G.scroll.x-(-this._target.x+G.widthHalf-13))/6,this._speedY=(G.scroll.y-(-this._target.y+G.heightHalf-t.y/15))/2,this._newY=G.scroll.y-Math.ceil(this._speedY),this._newY<0?(this._newY=0,this._speedY=0):Math.abs(this._newY)>this._areaHeight-G.height&&(this._newY=-this._areaHeight+G.height,this._speedY=0),G.scroll.y=this._newY}},t.prototype.setTarget=function(t,e){void 0===e&&(e=!1),this._target=t,e&&this.reset()},t.prototype.reset=function(){this._speedX=this._speedY=0,null!=this._target&&(G.scroll.x=-this._target.x+G.widthHalf-this.offset,G.scroll.y=-this._target.y+G.heightHalf,G.scroll.y<0&&(G.scroll.y=0))},t}();t.Camera=e,__reflect(e.prototype,"core.Camera")}(core||(core={}));var D=function(){function t(){}return t.init=function(){var t=this;null==this.towers&&RES.getResByUrl("tower_json",function(e){var i,n,s={};for(i=0;i<e.length;i++)n=e[i],s[n.ID]=n;t.towers=s},this,RES.ResourceItem.TYPE_JSON),null==this.creeps&&RES.getResByUrl("creep_json",function(e){var i,n,s={};for(i=0;i<e.length;i++)n=e[i],s[n.ID]=n;t.creeps=s},this,RES.ResourceItem.TYPE_JSON)},t.initmap=function(){this.map=RES.getRes("map_json")},t}();__reflect(D.prototype,"D");var DyEngine;!function(t){var e=function(){function t(){this.next=null,this.prev=null,this.data=null}return t.make=function(e){var i=new t;return i.data=e,i},t}();t.DyNode=e,__reflect(e.prototype,"DyEngine.DyNode")}(DyEngine||(DyEngine={}));var DyEngine;!function(t){var e=function(){function e(){this.first=null,this.last=null}return Object.defineProperty(e.prototype,"size",{get:function(){for(var t,e=this.first;e;)t++,e=e.next;return t},enumerable:!0,configurable:!0}),e.prototype.shift=function(){var t;return null!=this.first&&(t=this.first.data,this.removeNode(this.first)),t},e.prototype.insertAfter=function(t,e){e.prev=t,e.next=t.next,null==t.next?this.last=e:t.next.prev=e,t.next=e},e.prototype.remove=function(t){for(var e=this.first;e;)e.data==t&&this.removeNode(e),e=e.next},e.prototype.removeNode=function(t){null==t.prev?this.first=t.next:t.prev.next=t.next,null==t.next?this.last=t.prev:t.next.prev=t.prev,t.data=null,t.next=null,t.prev=null},e.prototype.unshift=function(e){var i=t.DyNode.make(e);null==this.first?(this.first=i,this.last=i,i.prev=null,i.next=null):this.insertBefore(this.first,i)},e.prototype.clear=function(){for(var t=this.first;t;)t.next=null,t.prev=null,t.data=null,t=t.next;this.first=null,this.last=null},e.prototype.replace=function(t,e){for(var i=this.first;i;)i.data==t&&(i.data=e),i=i.next},e.prototype.insertBefore=function(t,e){e.prev=t.prev,e.next=t,null==t.next?this.last=e:null!=t.prev&&(t.prev.next=e),t.prev=e},e.prototype.push=function(e){var i;null==this.last?this.unshift(e):(i=t.DyNode.make(e),this.insertAfter(this.last,i))},e.prototype.contains=function(t){for(var e=this.first;e;){if(e.data==t)return!0;e=e.next}return!1},e}();t.DyNodeList=e,__reflect(e.prototype,"DyEngine.DyNodeList")}(DyEngine||(DyEngine={}));var core;!function(t){var e=function(){function t(){}return t.init=function(){RES.getResByUrl("tower_json",function(e){var i,n,s=e,r=s.length,o={};for(i=0;r>i;i++)n=s[i],o[n.ID]=n;t.towers=o},this,RES.ResourceItem.TYPE_JSON)},t}();t.DataMgr=e,__reflect(e.prototype,"core.DataMgr")}(core||(core={}));var DyEngine;!function(t){var e=function(){function e(){this.pause=!1,this._balls=[]}return e.prototype.create=function(){this._balls=[]},e.prototype.clearWorld=function(t){void 0===t&&(t=!0),this._balls.length=0},e.prototype.addShape=function(t){this._balls.push(t)},e.prototype.removeShape=function(t){var e=this._balls.indexOf(t);e>-1&&this._balls.splice(e,1)},e.prototype.query=function(e,i,n){for(var s,r,o=this._balls,a=[],h=0;h<o.length;h++)s=o[h],r=t.DyMath.distance(e,i,s.x,s.y),n>r&&a.push(s.udata);return a},e.prototype.update=function(){if(!this.pause)for(var t=this._balls,e=0;e<t.length-1;e++)for(var i=t[e],n=e+1;n<t.length;n++){var s=t[n];this.checkCollision(i,s)}},e.prototype.checkCollision=function(e,i){var n=t.DyMath.distance(e.x,e.y,i.x,i.y);n<e.interestDist+i.interestDist&&(e.addContact(e,i),i.addContact(i,e))},e}();t.DyPhysics=e,__reflect(e.prototype,"DyEngine.DyPhysics")}(DyEngine||(DyEngine={}));var DyEngine;!function(t){var e=function(){function e(){this.contactEvent=new t.DyEvent}return e.make=function(t,i,n,s,r,o){void 0===r&&(r=0),void 0===o&&(o=0);var a=new e;return a.offsetx=i,a.offsetx=n,a.radius=s,a.width=r,a.height=o,a.udata=t,a},e.prototype.dist=function(t){var e=this.x-t.x,i=this.y-t.y,n=Math.sqrt(e*e+i*i);return n},e.prototype.addContact=function(t,e){this.contactEvent.send("collision",t,e)},e}();t.DyShape=e,__reflect(e.prototype,"DyEngine.DyShape")}(DyEngine||(DyEngine={}));var DyEngine;!function(t){var e=function(e){function i(){var i=e.call(this)||this;return i._defGroup=new t.DyGroup,i}return __extends(i,e),i.prototype.add=function(t){this._defGroup.add(t)},i}(egret.DisplayObjectContainer);t.DyState=e,__reflect(e.prototype,"DyEngine.DyState")}(DyEngine||(DyEngine={}));var DyEngine;!function(t){var e=function(){function e(){this._started=!1,this._pauseInterval=0,this._cycle=!1,this._pause=!1,this.onComplete=null,this._tasks=new t.DyNodeList,this._childs=[]}return Object.defineProperty(e.prototype,"size",{get:function(){return this._tasks.size},enumerable:!0,configurable:!0}),e.prototype.addTask=function(t,e,i,n){void 0===e&&(e=null),void 0===i&&(i=null),void 0===n&&(n=!1),this._tasks.push({func:t,args:e,ignoreCycle:n,sender:i}),this.start()},e.prototype.clear=function(){this.stop(),this._tasks.clear(),this._pauseInterval=0},e.prototype.stop=function(){this._started&&(this._started=!1)},e.prototype.addPause=function(t,e){void 0===e&&(e=!1),this.addTask(this.doPause,[t],this,e)},e.prototype.nextTask=function(t){void 0===t&&(t=!1),this._cycle&&!t?this._tasks.push(this._tasks.shift()):this._tasks.shift()},e.prototype.start=function(){this._started||(this._started=!0,this._pause=!1)},e.prototype.addInstantTask=function(t,e,i,n){void 0===e&&(e=null),void 0===i&&(i=null),void 0===n&&(n=!1),this._tasks.push({func:t,args:e,ignoreCycle:n,instant:!0,sender:i}),this.start()},e.prototype.addUrgentTask=function(t,e,i,n){void 0===e&&(e=null),void 0===i&&(i=null),void 0===n&&(n=!1),this._tasks.unshift({func:t,args:e,ignoreCycle:n,sender:i}),this.start()},e.prototype.addUrgentInstantTask=function(t,e,i,n){void 0===e&&(e=null),void 0===i&&(i=null),void 0===n&&(n=!1),this._tasks.unshift({func:t,args:e,ignoreCycle:n,instant:!0,sender:i}),this.start()},e.prototype.waitChilds=function(t){void 0===t&&(t=!1),this.addTask(this.allChildCompleted,[],this,t)},e.prototype.addChild=function(t){var e=this;t.onComplete=function(){var i=e._childs.indexOf(t);i>-1&&e._childs.splice(i,1)},this._childs.push(t)},e.prototype.allChildCompleted=function(){return 0==this._childs.length?!0:!1},e.prototype.toString=function(){return"{DyTaskManager [cycle: "+this._cycle+", numTasks: "+this._tasks.size+", started: "+this._started+", pause: "+this._pause+"]}"},e.prototype.doPause=function(t){return this._pauseInterval=this._pauseInterval+2*G.elapsed,this._pauseInterval>=t?(this._pauseInterval=0,!0):!1},Object.defineProperty(e.prototype,"pause",{get:function(){return this._pause},set:function(t){t&&!this._pause?(this._started,this._pause=!0):(this._started,this._pause=!1)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isRunning",{get:function(){return this._started&&!this._pause},enumerable:!0,configurable:!0}),e.prototype.update=function(){null!=this._tasks.first?this._task=this._tasks.first.data:this._task=null,null!=this._task&&this._started?(this._result=this._task.func.apply(this._task.sender,this._task.args),(this._task.instant||this._result)&&this.nextTask(this._task.ignoreCycle)):(this.stop(),null!=this.onComplete&&this.onComplete.apply(this));var t=this._childs;t.forEach(function(t,e,i){t.isRunning&&t.update()})},e}();t.DyTaskManager=e,__reflect(e.prototype,"DyEngine.DyTaskManager",["IUpdate"])}(DyEngine||(DyEngine={}));var DyEngine;!function(t){var e=function(e){function i(i){var n=e.call(this)||this;return n.animator=new t.DyAnimator,n._bitmap=new egret.Bitmap,n._parent=i,n.height=G.height,n.width=G.width,n.gravityEnable=!1,n}return __extends(i,e),i.prototype.addRes=function(t){var e=RES.getRes(t);this._bitmap.texture=e,this._bitmap.height=this.height,this._bitmap.width=this.width,this._bitmap.y=this.y,this._bitmap.fillMode=egret.BitmapFillMode.REPEAT,this._parent.container.addChild(this._bitmap)},i.prototype.update=function(){e.prototype.update.call(this),this._bitmap&&(this._bitmap.x=this.x,this._bitmap.y=this.y,this.onScreen()||(this._scrpoint.y>=G.height?this.y-=this._parent.height:this._scrpoint.y<=-G.height&&(this.y+=this._parent.height)))},i}(t.DyObject);t.DyTile=e,__reflect(e.prototype,"DyEngine.DyTile")}(DyEngine||(DyEngine={}));var DyEngine;!function(t){var e=function(e){function i(t){var i=e.call(this)||this;return i._arrTiles=[],i.container=t,i}return __extends(i,e),i.prototype.setSize=function(t,e){this._cols=t,this._rows=e,this.height=e*G.height,this.width=G.width},i.prototype.makeTils=function(){var e=0,i=0;for(e;e<this._cols;e++)for(i;i<this._rows;i++){var n=new t.DyTile(this);n.y=i*G.height,n.addRes("4399bg_jpg"),this._arrTiles.push(n)}},i.prototype.addTile=function(t){},i.prototype.update=function(){e.prototype.update.call(this);var t,i=0;for(i;i<this._arrTiles.length;i++)t=this._arrTiles[i],t.update()},i}(t.DyGroup);t.DyTileMap=e,__reflect(e.prototype,"DyEngine.DyTileMap")}(DyEngine||(DyEngine={}));var DyEngine;!function(t){var e=function(t){function e(){var i=t.call(this)||this;if(e.instance)throw new Error("只允许实例化一次！");return i}return __extends(e,t),e.getInstance=function(){return this.instance||(this.instance=new e),this.instance},e.prototype.start=function(){this._runnging||(this.stage.addEventListener(egret.Event.ENTER_FRAME,this.update,this),this._runnging=!0)},e.prototype.stop=function(){this._runnging&&(this.stage.removeEventListener(egret.Event.ENTER_FRAME,this.update,this),this._runnging=!1)},e.prototype.update=function(){this._runnging&&this.state&&this.state.update()},e}(egret.DisplayObjectContainer);t.Engine=e,__reflect(e.prototype,"DyEngine.Engine")}(DyEngine||(DyEngine={}));var Director=function(){function t(){if(egret.log("director",t.instance),t.instance)throw new Error("只允许实例化一次！")}return t.getInstance=function(){return this.instance||(this.instance=new t),this.instance},t.prototype.runWithCache=function(e,i,n){void 0===n&&(n=null);var s=t._Caches[e];s?this.runWithScene(s,n):(s=new i,t._Caches[e]=s,this.runWithScene(s,n))},t.prototype.runWithScene=function(t,e){function i(){n.currentScreen.free(),n.currentScreen=null,n.runWithScene(t,e)}void 0===e&&(e=null);var n=this;return null!=t&&t.initialize(),null!=this.currentScreen?void this.currentScreen.hide(i):void(null!=t&&(this.currentScreen=t,this.currentScreen.show(null,e)))},t._Caches={},t}();__reflect(Director.prototype,"Director");var gobjs;!function(t){var e=DyEngine.DyMath,i=function(i){function n(){var t=i.call(this)||this;return t.range=10,t.damage=0,t.dt=0,t.crit=0,t.speed=320,t.tx=0,t.ty=0,t._life=3,t._deg=0,t}return __extends(n,i),n.prototype.create=function(t,e){var i;if(null==this.clip){var n=RES.getRes(t+"_png"),s=RES.getRes(t+"_json"),r=new egret.MovieClipDataFactory(s,n);i=new egret.MovieClip(r.generateMovieClipData(e)),i.touchEnabled=!1,this.key=t+"_"+e,this.clip=i}else i=this.clip;this.exists=!0,this._layer=core.GameWorld.LAYER_OBJECTS,this.animator.addAnimation("def",i),this.animator.gotoAndStop(1),this.animator.switchAnimation("def"),this.Collider||(this.Collider=DyEngine.DyShape.make(this,0,0,2)),this.Collider.interestDist=this.range,this.Collider.contactEvent.on("collision",this.addContact,this),this.animator.x=this.x,this.animator.y=this.y,this._life=3,G.sWorld.addToLayer(this._layer,this),G.phys.addShape(this.Collider)},n.prototype.addContact=function(e,n){if(this.target&&!this.target.dead){i.prototype.addContact.call(this,e,n);var s=n.udata,r=DyEngine.DyMath.distance(this.x,this.y,s.x,s.y);if(s instanceof t.BasicUnit&&r<this.range&&this.target==s){this.target=s;var o=this.damage;s.typeDef!=this.dt&&(o=Math.round(.5*this.damage)),s.hurt(o,this.crit,this.tower),this.kill()}}},n.prototype.update=function(){if(this.target&&!this.target.dead){this.tx=this.target.x,this.ty=this.target.y;var t=this.speed,n=e.getAngle(this.x,this.y,this.tx,this.ty);this._vx=Math.cos(n)*t,this._vy=Math.sin(n)*t,this._deg=180*n/Math.PI}this.velocity.x=this._vx,this.velocity.y=this._vy,this.angle=this._deg,this._life-=2*G.elapsed,this._life<0&&this.kill(),i.prototype.update.call(this)},n.prototype.kill=function(){this.exists&&(this.dead=!0,this.Collider.contactEvent.clean(),G.phys.removeShape(this.Collider),this.clip.stop(),this.exists=!1,G.sWorld.removeFromLayer(this._layer,this))},n.prototype.free=function(){this.kill(),this.clip=null,this.Collider=null},n.make=function(t,e,i,s,r){var o=n.getAvail(e+"_"+i);return null==o&&(o=new n,n.members.push(o)),o.target=t,o.x=s,o.y=r,o.tx=t.x,o.ty=t.y,o.create(e,i),o},n.getAvail=function(t){for(var e,i=n.members.length,s=0;i>s;){if(e=n.members[s],null!=e&&!e.exists&&e.key==t)return e;s++}return null},n.destory=function(){for(var t,e=n.members.length,i=0;e>i;)t=n.members[i],null!=t&&t.free(),i++;n.members.length=0},n.members=[],n}(DyEngine.DyObject);t.Bullet=i,__reflect(i.prototype,"gobjs.Bullet")}(gobjs||(gobjs={}));var Main=function(t){function e(){var e=t.call(this)||this;return e.addEventListener(egret.Event.ADDED_TO_STAGE,e.onAddToStage,e),e}return __extends(e,t),e.prototype.onAddToStage=function(t){egret.Capabilities.isMobile&&(this.stage.scaleMode=egret.StageScaleMode.FIXED_WIDE),G.isMobile=egret.Capabilities.isMobile,egret.lifecycle.addLifecycleListener(function(t){}),egret.lifecycle.onPause=function(){egret.ticker.pause(),G.bgSoundChancel&&G.bgSoundChancel.stop(),G.figSndChancel&&G.figSndChancel.stop()},egret.lifecycle.onResume=function(){egret.ticker.resume(),G.bgMuz&&(G.bgSoundChancel=G.bgMuz.play()),G.figMuz&&(G.figSndChancel=G.bgMuz.play())},this.runGame()["catch"](function(t){console.log(t)})},e.prototype.runGame=function(){return __awaiter(this,void 0,void 0,function(){var t,e;return __generator(this,function(i){switch(i.label){case 0:return[4,this.loadResource()];case 1:return i.sent(),[4,RES.getResAsync("description_json")];case 2:return t=i.sent(),this.createGameScene(),[4,platform.login()];case 3:return i.sent(),[4,platform.getUserInfo()];case 4:return e=i.sent(),console.log(e),[2]}})})},e.prototype.loadResource=function(){return __awaiter(this,void 0,void 0,function(){var t,e;return __generator(this,function(i){switch(i.label){case 0:return i.trys.push([0,3,,4]),t=new LoadingUI(this.stage.stageWidth,this.stage.stageHeight),this.stage.addChild(t),[4,RES.loadConfig("resource/default.res.json","resource/")];case 1:return i.sent(),[4,RES.loadGroup("preload",0,t)];case 2:return i.sent(),this.stage.removeChild(t),[3,4];case 3:return e=i.sent(),console.error(e),[3,4];case 4:return[2]}})})},e.prototype.createGameScene=function(){fairygui.UIPackage.addPackage("tduilite"),fairygui.UIConfig.defaultFont="宋体",G.init(422,750,this.stage.stageWidth,this.stage.stageHeight),egret.log("sc",this.stage.stageWidth,this.stage.stageHeight),fairygui.UIObjectFactory.setPackageItemExtension(gui.DyProgressBar.url,gui.DyProgressBar);var t=this.stage.stageWidth-G.width*G.scale,e=DyEngine.Engine.getInstance();e.x=.5*t;var i=new egret.Shape;i.graphics.lineStyle(0),i.graphics.beginFill(65280),i.graphics.drawRect(e.x,e.x,G.width*G.scale,G.height*G.scale),i.graphics.endFill(),e.mask=i,e.scaleX=e.scaleY=G.scale,this.stage.addChild(e),this.stage.addChild(i),fairygui.GRoot.inst.displayObject.x=.5*t,fairygui.GRoot.inst.scaleX=G.scale,fairygui.GRoot.inst.scaleY=G.scale,this.stage.addChild(fairygui.GRoot.inst.displayObject),G.director.runWithCache("mainmenu",MainMenu);var n=this.createBitmapByName("mask_png");n.x=0,n.y=0,n.width=G.width,n.height=this.stage.stageHeight,n.fillMode=egret.BitmapFillMode.REPEAT,this.stage.addChildAt(n,0)},e.prototype.createBitmapByName=function(t){var e=new egret.Bitmap,i=RES.getRes(t);return e.texture=i,e},e}(egret.DisplayObjectContainer);__reflect(Main.prototype,"Main");var gobjs;!function(t){var e=function(t){function e(){return t.call(this)||this}return __extends(e,t),e.prototype.create=function(t){this.exists=!0,this.graphics.beginFill(0,.3),this.graphics.lineStyle(.1,13421772),0==this.typeid?this.graphics.drawEllipse(-15,-2.5,30,5):this.graphics.drawCircle(0,0,t),this.graphics.endFill()},e.make=function(t,i,n,s){void 0===s&&(s=1);var r=e.getAvail(t);return null==r&&(r=new e,e.members.push(r)),r.typeid=t,r.create(s),r.x=i,r.y=n,r},e.prototype.kill=function(){this.parent&&this.parent.removeChild(this),this.exists=!1},e.getAvail=function(t){for(var i,n,s=e.members.length;s>n;){if(i=e.members[n],null!=i&&!i.exists&&i.typeid==t)return i;n++}return null},e.members=[],e}(egret.Shape);t.EffectShadow=e,__reflect(e.prototype,"gobjs.EffectShadow")}(gobjs||(gobjs={}));var core;!function(t){var e=function(t){function e(){return t.call(this)||this}return __extends(e,t),e.prototype.imgLoadHandler=function(t){var e=t.currentTarget,i=e.data,n=new egret.Texture;n.bitmapData=i,this.onExternalLoadSuccess(n)},e}(fairygui.GLoader);t.DyGLoader=e,__reflect(e.prototype,"core.DyGLoader"),e.prototype.loadExternal=function(){var t=new egret.ImageLoader;t.once(egret.Event.COMPLETE,this.imgLoadHandler,this),t.load(this.url)}}(core||(core={}));var gobjs;!function(t){var e=function(e){function i(){var t=e.call(this)||this;return t._cd=0,t.damage=0,t.range=100,t.typeDamage=1,t.canAir=!1,t.delay=1,t.crit=10,t.maxtarget=1,t.extargold=0,t._elpased=0,t.gravityEnable=!1,t}return __extends(i,e),i.prototype.create=function(){var e=this;this._cd=0,this.cid=this.entry.substr(0,2);var i=G.talent(this.cid);i>=1&&(this.damage=1.2*this.damage),i>=2&&(this.range=1.2*this.range),i>=3&&(this.delay=.8*this.delay),this.animator.addAnimation("idle",G.getTowerClip(this.entry)),this.animator.addAnimation("attack",G.getTowerClip(this.entry+"g")),this.animator.switchAnimation("idle",!0),this.animator.touchEnabled=!0,this.animator.gotoAndPlay(1),this.animator.frameEvent.on("onlab",function(t,i){if("ef"==t){var n=i.indexOf("#"),s=i.substring(0,n).split(":"),r=i.substring(n+1).split(","),o=r[0],a=r[1];utils.EffectClip.make(e.animator,s[0],s[1],o,a)}else if("atk"==t)e.doMelee(),e._cd=e.delay;else if("arc"==t){var h=i.split(",");h&&3==h.length&&(e.doArcher(h[0],Number(h[1]),Number(h[2])),e._cd=e.delay)}else if("mag"==t){var h=i.split(",");h&&3==h.length&&(e.doFireBall(h[0],Number(h[1]),Number(h[2])),e._cd=e.delay)}else if("snd"==t){var l=new egret.Sound;l.once(egret.Event.COMPLETE,function(t){l.play(0,1)},e),l.load("resource/snd/"+i+".mp3")}},this.animator),this.animator.frameEvent.on("onend",this.onAniComplete,this),this._shadow=t.EffectShadow.make(0,this.x,this.y),this.animator.addChildAt(this._shadow,0),this.Collider=DyEngine.DyShape.make(this,0,0,100,0,0),this.Collider.interestDist=this.range,this.Collider.contactEvent.on("collision",this.addContact,this),G.phys.addShape(this.Collider)},i.prototype.onAniComplete=function(){this._cd>0||null==this.target?this.animator.switchAnimation("idle"):this.target&&(this.target.x<this.x?this.scale.x=-1:this.scale.x=1,this.animator.switchAnimation("attack"),this.animator.gotoAndPlay(1))},i.prototype.addContact=function(i,n){e.prototype.addContact.call(this,i,n);var s=n.udata;if(s instanceof t.BasicUnit){if(s.inAir&&!this.canAir)return;var r=DyEngine.DyMath.distance(this.x,this.y,s.x,s.y);r<this.range&&null==this.target&&(this.target=s)}},i.make=function(t,e,n){var s=new i;s.entry=t;var r=D.towers[t];return s.damage=r.dmg,s.range=r.range,s.typeDamage=r.dt,s.canAir=2==r.air,s.delay=Number(r.spd),s.crit=Number(r.crit),s.maxtarget=Number(r.amount),s.extargold=Number(r.extra),s.create(),s.x=e,s.y=n,s},i.prototype.startBuild=function(){if(null==this._bar){var t=utils.BuildBar.make(this,0,0);this._bar=t,this.busying=!0}},i.prototype.doFireBall=function(e,i,n){if(this.target&&!this.target.dead){var s=t.Bullet.make(this.target,"ta","fireball",this.x+i*this.scale.x,this.y+n);s.damage=this.damage,s.crit=this.crit,s.tower=this,s.dt=this.typeDamage}},i.prototype.doArcher=function(e,i,n){if(this.target&&!this.target.dead){var s=t.Bullet.make(this.target,"ta","arrow1",this.x+i*this.scale.x,this.y+n);s.damage=this.damage,s.crit=this.crit,s.tower=this,s.dt=this.typeDamage}},i.prototype.doMelee=function(){var t=this.target;if(t&&!t.dead){var e=this.damage;t.typeDef!=this.typeDamage&&(e=Math.round(.5*this.damage)),t.hurt(e,0,this)}},i.prototype.outfig=function(){this.target=null},i.prototype.update=function(){e.prototype.update.call(this);var t=this.target;if(this._cd=this._cd-2*G.elapsed,t)if(t.dead)this.outfig();else{var i=DyEngine.DyMath.distance(this.x,this.y,t.x,t.y);i>this.range&&this.outfig()}if(this.busying){this._elpased+=2*G.elapsed;var n=this._bar;n&&n.update(this._elpased,1),this._elpased>1&&(this.busying=!1,this._elpased=0,this._bar.kill(),this._bar=null,this.events.send("build",this))}},i.prototype.kill=function(){e.prototype.kill.call(this),this._shadow&&this._shadow.kill()},i.prototype.onTouchEnd=function(t){gui.BuildMenu.show(this,this.x,this.y)},i}(DyEngine.DyObject);t.eTower=e,__reflect(e.prototype,"gobjs.eTower")}(gobjs||(gobjs={}));var gui;!function(t){var e=core.GameWorld,i=function(t){function i(){var e=t.call(this)||this;return e.busy=!1,e}return __extends(i,t),i.prototype.constructFromXML=function(e){t.prototype.constructFromXML.call(this,e),this._c1=this.getController("c1"),this._t1=this.getTransition("t0"),this._t2=this.getTransition("t1"),this._btnWar=this.getChild("n22").asButton,this._btnWar.addEventListener(egret.TouchEvent.TOUCH_END,this.onEnter,this),this._btnArc=this.getChild("n25").asButton,this._btnArc.addEventListener(egret.TouchEvent.TOUCH_END,this.onEnter,this),this._btnAss=this.getChild("n23").asButton,this._btnAss.addEventListener(egret.TouchEvent.TOUCH_END,this.onEnter,this),this._btnMag=this.getChild("n24").asButton,this._btnMag.addEventListener(egret.TouchEvent.TOUCH_END,this.onEnter,this),this._btnUpd=this.getChild("n26").asButton,this._btnUpd.addEventListener(egret.TouchEvent.TOUCH_END,this.onUpd,this),this._btnSell=this.getChild("n27").asButton,this._btnSell.addEventListener(egret.TouchEvent.TOUCH_END,this.onSell,this)},i.prototype.create=function(){this.getController("c2").selectedIndex=0;var t=core.DataMgr.towers;if(this.go instanceof gobjs.eTower){this._c1.selectedIndex=1;var e=t[this.go.entry];if(this._btnSell.title=e.sell,"NA"==e.nextlev)this._btnUpd.enabled=!1;else if(e.nextlev.indexOf(",")>=0)this._btnUpd.enabled=!1;else{var i=t[e.nextlev],n=i.price,s=1;G.talent(this.go.cid)>=4&&(s=.8),this._btnUpd.title=i.price,n>G.gold?this._btnUpd.enabled=!1:this._btnUpd.enabled=!0,-1==G.sd.shop.indexOf(e.nextlev)&&(this._btnUpd.enabled=!1)}utils.EffectRange.make(this.go.range,this.go.x,this.go.y)}else{this._c1.selectedIndex=0;var e=t.zs001,s=1;G.talent("zs")>=4&&(s=.8);var n=Math.round(e.price*s);this._btnWar.title=String(n),n>G.gold?this._btnWar.enabled=!1:this._btnWar.enabled=!0,e=t.yx001,n=e.price,this._btnArc.title=e.price,n>G.gold?this._btnArc.enabled=!1:this._btnArc.enabled=!0,e=t.ck001,n=e.price,this._btnAss.title=e.price,n>G.gold?this._btnAss.enabled=!1:this._btnAss.enabled=!0,e=t.fs001,n=e.price,this._btnMag.title=e.price,n>G.gold?this._btnMag.enabled=!1:this._btnMag.enabled=!0}this._t1.play()},i.show=function(t,e,n){i.instance||(i.instance=fairygui.UIPackage.createObjectFromURL(i.url,i)),i.instance.busy||(i.instance.x=e,i.instance.y=n,i.instance.go=t,i.instance.create(),fairygui.GRoot.inst.addChild(i.instance))},i.hide=function(){if(i.instance){i.instance.go;i.instance.close()}utils.EffectRange.hide()},i.prototype.close=function(){this.go=null,this._t2.play(function(){fairygui.GRoot.inst.removeChild(i.instance)})},i.prototype.setup_afterAdd=function(e){t.prototype.setup_afterAdd.call(this,e),this._mapid=this._name.substr(1)},i.prototype.onUpd=function(t){var n=this,s=this.go;utils.EffectRange.hide();var r=core.DataMgr.towers,o=r[s.entry],a=r[o.nextlev],h=a.price;G.gold<h||(this.busy=!0,s instanceof gobjs.eTower&&(s.events.on("build",function(t){var i=gobjs.eTower.make(a.ID,t.x,t.y);G.sWorld.addToLayer(e.LAYER_OBJECTS,i),G.sWorld.removeFromLayer(e.LAYER_OBJECTS,t),G.uimgr.sendNotification("upd"),G.gold-=h,observer.UIManager.send("upd_gold");var s=new egret.Sound;s.once(egret.Event.COMPLETE,function(t){s.play(0,1)},n),s.load("resource/snd/build1.mp3"),n.busy=!1},this),s.startBuild()),this.go=null,this._t2.play(function(){fairygui.GRoot.inst.removeChild(i.instance)}))},i.prototype.onSell=function(t){if(this.go){G.sWorld.removeFromLayer(e.LAYER_OBJECTS,this.go),G.uimgr.sendNotification("upd");var n=core.DataMgr.towers[this.go.entry];G.gold+=DyEngine.DyMath.toNumber(n.sell),observer.UIManager.send("upd_gold");var s=gobjs.eBase.make(this.go.x,this.go.y);G.sWorld.addToLayer(e.LAYER_OBJECTS,s)}i.hide()},i.prototype.onEnter=function(t){var e,i=core.DataMgr.towers,n=1;switch(t.currentTarget){case this._btnWar:e=i.zs001,G.talent("zs")>=4&&(n=.8),utils.EffectRange.make(e.range,this.go.x,this.go.y),this._btnWar.selected&&this.build(e,n);break;case this._btnArc:e=i.yx001,G.talent("yx")>=4&&(n=.8),utils.EffectRange.make(e.range,this.go.x,this.go.y),this._btnArc.selected&&this.build(e,n);break;case this._btnAss:e=i.ck001,G.talent("ck")>=4&&(n=.8),utils.EffectRange.make(e.range,this.go.x,this.go.y),this._btnAss.selected&&this.build(e,n);break;case this._btnMag:e=i.fs001,G.talent("fs")>=4&&(n=.8),utils.EffectRange.make(e.range,this.go.x,this.go.y),this._btnMag.selected&&this.build(e,n)}},i.prototype.build=function(t,n){var s=this,r=this.go;utils.EffectRange.hide();Math.round(t.price*n);G.gold-=t.price,this.busy=!0,observer.UIManager.send("upd_gold"),r instanceof gobjs.eBase&&(r.events.on("build",function(i){var n=gobjs.eTower.make(t.ID,i.x,i.y);G.sWorld.addToLayer(e.LAYER_OBJECTS,n),G.sWorld.removeFromLayer(e.LAYER_OBJECTS,i),G.uimgr.sendNotification("upd"),s.busy=!1},this),r.startBuild()),this.go=null,this._t2.play(function(){fairygui.GRoot.inst.removeChild(i.instance)})},i.url="ui://y1w8mpywhi9w1j",i}(fairygui.GComponent);t.BuildMenu=i,__reflect(i.prototype,"gui.BuildMenu")}(gui||(gui={}));var gui;!function(t){var e=function(){function t(){}return t.make=function(e,i,n,s){return void 0===n&&(n=null),void 0===s&&(s=null),null==t.inst&&(t.inst=new t),t.inst.create(e,i),t.inst.cb=n,t.inst.sender=s,t.inst},t.prototype.create=function(t,e){this._inited||(this._view=fairygui.UIPackage.createObject("tdui1","购买确认").asCom,this._view.getChild("n109").asButton.addEventListener(egret.TouchEvent.TOUCH_END,this.onClose,this),this._c1=this._view.getController("c1"),this._tfInfo=this._view.getChild("n112").asTextField,this._tferr=this._view.getChild("n114").asTextField,this._btn1=this._view.getChild("b1").asButton,this._btn1.addEventListener(egret.TouchEvent.TOUCH_END,this.onBuy,this),this._btn2=this._view.getChild("b2").asButton,this._btn2.addEventListener(egret.TouchEvent.TOUCH_END,this.onClose,this),this._view.setSize(fairygui.GRoot.inst.width,fairygui.GRoot.inst.height)),this._tfInfo.text=t,null!=e?(this._c1.selectedIndex=1,this._tferr.text=e):this._c1.selectedIndex=0,fairygui.GRoot.inst.addChild(this._view)},t.prototype.onBuy=function(t){fairygui.GRoot.inst.removeChild(this._view),null!=this.cb&&this.cb.apply(this.sender)},t.prototype.onClose=function(t){fairygui.GRoot.inst.removeChild(this._view)},t}();t.BuyUI=e,__reflect(e.prototype,"gui.BuyUI")}(gui||(gui={}));var gui;!function(t){var e=function(){function t(){}return t.make=function(e,i,n){var s=new t;return s.type=e,s.create(i,n),s},t.prototype.create=function(t,e){this._view=fairygui.UIPackage.createObject("tdui1","出怪提示").asCom,this._view.addEventListener(egret.TouchEvent.TOUCH_END,this.onStart,this),this._c1=this._view.getController("c1"),this._c1.selectedIndex=this.type,fairygui.GRoot.inst.addChild(this._view),this._tfSec=this._view.getChild("title").asTextField,this._view.x=t,this._view.y=e;var i=new egret.Sound;i.addEventListener(egret.Event.COMPLETE,function(t){egret.log("ok")},this),i.load("resource/snd/fight.mp3"),this._sound=i},t.prototype.close=function(){fairygui.GRoot.inst.removeChild(this._view)},t.prototype.setSec=function(t){G.sWorld.started?this._tfSec.text=String(t):this._tfSec.text="开始"},t.prototype.onStart=function(){if(this._sound.play(0,1),G.sWorld.started){var t=Number(this._tfSec.text);G.gold+=t,observer.UIManager.send("upd_gold")}else G.sWorld.started=!0;G.sWorld.pauseInterval=G.DELAY,this.close()},t.RIGHT=0,t.LEFT=1,t.UP=2,t.DOWN=4,t}();t.WaveAction=e,__reflect(e.prototype,"gui.WaveAction")}(gui||(gui={}));var gui;!function(t){var e=function(t){function e(){return t.call(this)||this}return __extends(e,t),e.prototype.onProgress=function(t,e){this.value=Math.round(t/e*100)},e.url="ui://lk73k1zmokx47",e}(fairygui.GProgressBar);t.DyProgressBar=e,__reflect(e.prototype,"gui.DyProgressBar",["RES.PromiseTaskReporter"])}(gui||(gui={}));var gui;!function(t){var e=function(){function t(){}return t.make=function(e,i,n){return null==t.inst&&(t.inst=new t),t.inst.mapid=n,t.inst.create(e,i),G.onceSnd("openui"),t.inst},t.prototype.create=function(t,e){var i=this;this._inited||(this._view=fairygui.UIPackage.createObject("tdui1","关卡介绍面板").asCom,this._view.getChild("n45").asButton.addEventListener(egret.TouchEvent.TOUCH_END,this.onStart,this),this._view.getChild("n46").asButton.addEventListener(egret.TouchEvent.TOUCH_END,this.onClose,this),this._c1=this._view.getController("c1"),this._c1.addEventListener(fairygui.StateChangeEvent.CHANGED,this.onChange,this),this._c2=this._view.getController("c2"),this._tfInfo=this._view.getChild("n42").asTextField,this._tfTitle=this._view.getChild("n41").asTextField,this._tfwc=this._view.getChild("n44").asTextField,this._view.setSize(G.width,G.height)),fairygui.GRoot.inst.addChild(this._view),RES.getResByUrl("level"+this.mapid+"_json",function(t){i._c2.selectedIndex=1,i._mapConfig=t,i._tfTitle.text=t.name,i._tfInfo.text=t.info,i._tfwc.text=t.data.length,G.gold=t.gold,i._c1.selectedIndex=0,G.gLevel=0,i._rec=G.sd.rec[i._mapConfig.id],null==i._rec&&(i._rec=[])},this,RES.ResourceItem.TYPE_JSON)},t.prototype.onChange=function(t){var e=this._c1.selectedIndex,i=this._view.getChild("n45");if(e>0){var n=DyEngine.DyMath.toNumber(this._rec[e-1]);0==n?i.visible=!1:i.visible=!0}else i.visible=!0;G.gLevel=e},t.prototype.onClose=function(t){this._c2.selectedIndex=0,fairygui.GRoot.inst.removeChild(this._view),G.onceSnd("close")},t.prototype.onStart=function(){G.onceSnd("fight"),G.director.runWithScene(new LevelLoadingScene,[this._mapConfig]),fairygui.GRoot.inst.removeChild(this._view)},t}();t.EnterUI=e,__reflect(e.prototype,"gui.EnterUI")}(gui||(gui={}));var gui;!function(t){var e=function(){function e(){this._inited=!1,this._rew=0,this._v=0}return e.make=function(t){null==e.inst&&(e.inst=new e),e.inst.create(t)},e.prototype.create=function(t){if(this._inited||(this._view=fairygui.UIPackage.createObject("tdui1","关卡结算").asCom,this._view.setSize(G.width,G.height),this._btn1=this._view.getChild("btn1").asButton,this._btn2=this._view.getChild("btn2").asButton,this._btn3=this._view.getChild("n15").asButton,this._btn1.addEventListener(egret.TouchEvent.TOUCH_END,this.onBtn,this),this._btn2.addEventListener(egret.TouchEvent.TOUCH_END,this.onBtn,this),this._btn3.addEventListener(egret.TouchEvent.TOUCH_END,this.onBtn,this),this._tfddb=this._view.getChild("n1").asCom.getChild("n6").asTextField,this._tfelpased=this._view.getChild("n1").asCom.getChild("n8").asTextField,this._inited=!0),this._view.getController("c1").selectedIndex=t,0==t){var e=G.sWorld.config.ddb;
1==G.gLevel?e=Math.round(1.5*e):2==G.gLevel&&(e=2*e);var i=G.sWorld.config.id;this._rew=e,this._tfddb.text=String(e),G.sd.ddb+=e;var n=G.sd.rec[i];null==n&&(n=[0,0,0,0,0,0]),n[G.gLevel]+=1;var s=G.sWorld.home,r=G.gLevel+3;0==Number(n[r])&&s.health==s.hpmax&&(G.sd.star++,G.sd.score+=100,n[r]=1),G.sd.rec[i]=n,egret.localStorage.setItem(G.SAVEKEY,JSON.stringify(G.sd)),G.onceSnd("vic"),G.sd.score+=G.gLevel,this._btn1.enabled=!1,this._btn2.enabled=!1,this._tfddb.addEventListener(egret.Event.ENTER_FRAME,this.onAnim,this)}else G.onceSnd("fail");var o=window.h5api,a=DyEngine.DyMath.toNumber(G.sd.tt);o&&o.canPlayAd()&&10>a?this._btn3.visible=!0:this._btn3.visible=!1;var h=Math.round(G.sWorld.elpased),l=h%60,c=Math.floor(h/60);this._tfelpased.text=G.str_pad(String(c),2,"0")+":"+G.str_pad(l.toString(),2,"0"),fairygui.GRoot.inst.addChild(this._view)},e.prototype.onAnim=function(t){this._v+=Math.floor(8*Math.random()+1),this._v>this._rew&&(this._v=this._rew,this._tfddb.removeEventListener(egret.Event.ENTER_FRAME,this.onAnim,this),this._btn1.enabled=!0,this._btn2.enabled=!0),this._tfddb.text=String(Math.round(this._v))},e.prototype.onBtn=function(e){var i=this;switch(e.currentTarget){case this._btn1:G.gold=G.sWorld.config.gold,G.director.runWithScene(new LevelLoadingScene,[G.sWorld.config]),this.close();break;case this._btn2:G.director.runWithScene(new LevelScene),this.close();break;case this._btn3:var n=fairygui.UIPackage.createObject("tdui1","广告确认面板").asCom;fairygui.GRoot.inst.addChild(n);var s=n.getChild("b1").asButton,r=n.getChild("b2").asButton,o=function(e){fairygui.GRoot.inst.removeChild(n);var r=window.h5api;r&&(t.WaittingUI.make(),r.playAd(function(e){if(t.WaittingUI.hide(),console.log("代码:"+e.code+",消息:"+e.message),1e4===e.code)console.log("开始播放");else if(10001===e.code){console.log("播放结束"),G.sd.ddb+=20;var i=DyEngine.DyMath.toNumber(G.sd.tt);i++,10>i&&(G.sd.tt=i),observer.UIManager.send("upd_gold")}else console.log("广告异常")}),s.removeEventListener(egret.TouchEvent.TOUCH_END,o,i))},a=function(t){fairygui.GRoot.inst.removeChild(n),r.removeEventListener(egret.TouchEvent.TOUCH_END,a,i)};s.addEventListener(egret.TouchEvent.TOUCH_END,o,this),r.addEventListener(egret.TouchEvent.TOUCH_END,a,this)}},e.prototype.close=function(){fairygui.GRoot.inst.removeChild(this._view)},e}();t.GameEnd=e,__reflect(e.prototype,"gui.GameEnd")}(gui||(gui={}));var gui;!function(t){var e=function(e){function i(){return e.call(this)||this}return __extends(i,e),i.prototype.constructFromXML=function(t){e.prototype.constructFromXML.call(this,t),this._c1=this.getController("c1"),this._c2=this.getController("c2"),this.addClickListener(this.onEnter,this)},i.prototype.setup_afterAdd=function(t){e.prototype.setup_afterAdd.call(this,t);var i=this._name,n=D.map[i];this._mapid=n.id;var s=G.sd,r=s.rec[n.req];r?0==r[0]?this._c1.selectedIndex=1:this._c1.selectedIndex=0:null==n.req?this._c1.selectedIndex=0:this._c1.selectedIndex=1;var o=G.sd.rec[i];if(o){var a=DyEngine.DyMath;this._c1.selectedIndex=2,Number(o[5])>0?(this._c2.selectedIndex=3,0==a.toNumber(o[8])&&(this.getTransition("t0").play(),o[8]=1)):Number(o[4])>0?(this._c2.selectedIndex=2,0==a.toNumber(o[7])&&(this.getTransition("t0").play(),o[7]=1)):Number(o[3])>0&&(this._c2.selectedIndex=1,0==a.toNumber(o[6])&&(this.getTransition("t0").play(),o[6]=1))}else this._c2.selectedIndex=0},i.prototype.onEnter=function(e){1!=this._c1.selectedIndex&&t.EnterUI.make(100,100,this._mapid)},i.url="ui://y1w8mpywycfwd",i}(fairygui.GComponent);t.LevelPort=e,__reflect(e.prototype,"gui.LevelPort")}(gui||(gui={}));var gui;!function(t){var e=function(){function t(){this.create()}return t.prototype.create=function(){var t=this;this._view=fairygui.UIPackage.createObject("tdui1","005 排行榜").asCom,this._btn=this._view.getChild("n2").asButton,this._btn.addEventListener(egret.TouchEvent.TOUCH_END,this.onClose,this),this._tfgold=this._view.getChild("n5").asTextField,this._list=this._view.getChild("n16").asList,this._view.setSize(G.width,G.height),fairygui.GRoot.inst.addChild(this._view);var e=DyEngine.DyMath.toNumber(G.sd.score);this._tfgold.text=String(e),observer.UIManager.getInstance().registerUI(this),this._list.removeChildrenToPool();var i=function(e){if(1e4==e.code){var i=e.data;t._list.removeChildrenToPool();var n=i.length;n>11&&(n=11);for(var s=0;n>s;s++){var r=t._list.addItemFromPool().asCom;r.getChild("n14").asTextField.text=i[s].rank,r.getChild("n15").asTextField.text=i[s].score}}else egret.log("error:",e)},n=window.h5api;n&&(console.log("开始上传"),e>0?n.submitScore(e,function(t){console.log("代码:"+t.code+",消息:"+t.message+",数据:"+t.data),1e4===t.code?console.log("上传成功"):console.log("上传失败"),n.getRank(i)}):n.getRank(i))},t.prototype.onActived=function(t){var e=t.currentTarget;setTimeout(function(){e.selected=!1},1e3)},t.prototype.onClose=function(t){this._btn.removeEventListener(egret.TouchEvent.TOUCH_END,this.onClose,this),fairygui.GRoot.inst.removeChild(this._view),observer.UIManager.getInstance().removeUI(this.getMediatorName())},t.prototype.getMediatorName=function(){return"RankUI"},t.prototype.listNotificationInterests=function(){return["upd_rank"]},t.prototype.handleNotification=function(t){switch(t.name){case"upd_rank":this._tfgold.text=String(DyEngine.DyMath.toNumber(G.sd.score))}},t.prototype.onRegister=function(){},t.prototype.onRemove=function(){},t}();t.RankUI=e,__reflect(e.prototype,"gui.RankUI",["INotifier"])}(gui||(gui={}));var gui;!function(t){var e=function(e){function i(){return e.call(this)||this}return __extends(i,e),i.prototype.constructFromXML=function(i){var n=this;e.prototype.constructFromXML.call(this,i),this._img=this.getChild("n4").asLoader,this.addEventListener(egret.TouchEvent.TOUCH_END,function(e){if(1!=n.getController("button").selectedIndex){var i=G.SHOP[n._name],s=G.sd.shop;return i.req&&-1==s.indexOf(i.req)?(egret.log("请先购买前置等级!"),void t.BuyUI.make("要花费"+i.g+"金币购买这个升级吗？\n升级后可以在游戏里建造这个级别的防御塔。","请先购买前置等级!")):G.sd.ddb<i.g?void t.BuyUI.make("要花费"+i.g+"金币购买这个升级吗？\n升级后可以在游戏里建造这个级别的防御塔。","你的金币不够!"):void t.BuyUI.make("要花费"+i.g+"金币购买这个升级吗？\n升级后可以在游戏里建造这个级别的防御塔。",null,function(){G.sd.ddb-=i.g,G.sd.score+=100,n.getController("button").selectedIndex=1,G.sd.shop.push(n._name),observer.UIManager.send("upd_shop"),egret.localStorage.setItem(G.SAVEKEY,JSON.stringify(G.sd))},n)}},this)},i.prototype.setup_afterAdd=function(t){e.prototype.setup_afterAdd.call(this,t);var n=this._name.substr(-1,1);this._img.url=i.URLS[n],-1!=G.sd.shop.indexOf(this._name)?this.getController("button").selectedIndex=1:this.getController("button").selectedIndex=0},i.url="ui://y1w8mpywgkuz2q",i.URLS={2:"ui://y1w8mpywgkuz2m",3:"ui://y1w8mpywgkuz2n",4:"ui://y1w8mpywgkuz2o",5:"ui://y1w8mpywgkuz2p"},i}(fairygui.GComponent);t.shopCell=e,__reflect(e.prototype,"gui.shopCell")}(gui||(gui={}));var gui;!function(t){var e=function(){function t(){this.create()}return t.prototype.create=function(){this._view=fairygui.UIPackage.createObject("tdui1","商店").asCom,this._btn=this._view.getChild("n68").asButton,this._btn.addEventListener(egret.TouchEvent.TOUCH_END,this.onClose,this),this._tfgold=this._view.getChild("n111").asTextField,this._view.setSize(G.width,G.height),fairygui.GRoot.inst.addChild(this._view),this._tfgold.text=G.sd.ddb,observer.UIManager.getInstance().registerUI(this),G.onceSnd("openui")},t.prototype.onActived=function(t){var e=t.currentTarget;setTimeout(function(){e.selected=!1},1e3)},t.prototype.onClose=function(t){this._btn.removeEventListener(egret.TouchEvent.TOUCH_END,this.onClose,this),fairygui.GRoot.inst.removeChild(this._view),observer.UIManager.getInstance().removeUI(this.getMediatorName()),G.onceSnd("close")},t.prototype.getMediatorName=function(){return"ShopUI"},t.prototype.listNotificationInterests=function(){return["upd_shop"]},t.prototype.handleNotification=function(t){switch(t.name){case"upd_shop":this._tfgold.text=String(DyEngine.DyMath.toNumber(G.sd.ddb))}},t.prototype.onRegister=function(){},t.prototype.onRemove=function(){},t}();t.ShopUI=e,__reflect(e.prototype,"gui.ShopUI",["INotifier"])}(gui||(gui={}));var gui;!function(t){var e=DyEngine.DyMath,i=function(i){function n(){return i.call(this)||this}return __extends(n,i),n.prototype.constructFromXML=function(t){i.prototype.constructFromXML.call(this,t),this._img=this.getChild("icon").asLoader},n.prototype.setup_afterAdd=function(t){i.prototype.setup_afterAdd.call(this,t);var s=this._name.substr(-1,1);this._cid=this._name.substr(0,2),this._img.url=n.URLS[s];var r=G.TALENT[this._name];this.getController("c1").selectedIndex=r.g-1,this.getChild("title").asTextField.text=r.title;var o=G.sd.tal;(null==o||0==o.length)&&(o={});var a=e.toNumber(o[this._cid]);e.toNumber(s)<a?this.getController("c2").selectedIndex=1:(this.getController("c2").selectedIndex=0,this.addEventListener(egret.TouchEvent.TOUCH_END,this.onClick,this))},n.prototype.onClick=function(i){var n=this,s=G.sd.tal;(null==s||0==s.length)&&(s={});var r=G.TALENT[this._name],o=e.toNumber(this._name.substr(-1,1)),a=e.toNumber(s[this._cid]),h=r.req;return h!=a?(egret.log("请先购买前置等级!"),void t.BuyUI.make("要花费"+r.g+"星激活这个天赋。","请先激活前置等级!")):G.sd.star<r.g?void t.BuyUI.make("要花费"+r.g+"星激活这个天赋。","没有足够的星星!"):void t.BuyUI.make("要花费"+r.g+"星激活这个天赋。",null,function(){G.sd.star-=r.g,egret.log("start:",G.sd.star),n.getController("c2").selectedIndex=1,s[n._cid]=o+1,G.sd.score+=100,G.sd.tal=s,observer.UIManager.send("upd_talnet"),n.removeEventListener(egret.TouchEvent.TOUCH_END,n.onClick,n),egret.localStorage.setItem(G.SAVEKEY,JSON.stringify(G.sd))},this)},n.url="ui://y1w8mpywp8vx1u",n.URLS={0:"ui://y1w8mpywp8vx1p",1:"ui://y1w8mpywp8vx1o",2:"ui://y1w8mpywp8vx1q",3:"ui://y1w8mpywp8vx1n"},n}(fairygui.GComponent);t.talentCell=i,__reflect(i.prototype,"gui.talentCell")}(gui||(gui={}));var gui;!function(t){var e=function(){function t(){this.create()}return t.prototype.create=function(){this._view=fairygui.UIPackage.createObject("tdui1","004 天赋").asCom,this._btn=this._view.getChild("n2").asButton,this._btn.addEventListener(egret.TouchEvent.TOUCH_END,this.onClose,this),this._tfgold=this._view.getChild("n12").asTextField,this._view.setSize(fairygui.GRoot.inst.width,fairygui.GRoot.inst.height),fairygui.GRoot.inst.addChild(this._view),this._tfgold.text=G.sd.star,observer.UIManager.getInstance().registerUI(this),G.onceSnd("openui")},t.prototype.onActived=function(t){var e=t.currentTarget;setTimeout(function(){e.selected=!1},1e3)},t.prototype.onClose=function(t){this._btn.removeEventListener(egret.TouchEvent.TOUCH_END,this.onClose,this),fairygui.GRoot.inst.removeChild(this._view),observer.UIManager.getInstance().removeUI(this.getMediatorName()),G.onceSnd("close")},t.prototype.getMediatorName=function(){return"TalentUI"},t.prototype.listNotificationInterests=function(){return["upd_talnet"]},t.prototype.handleNotification=function(t){switch(t.name){case"upd_talnet":this._tfgold.text=String(G.sd.star)}},t.prototype.onRegister=function(){},t.prototype.onRemove=function(){},t}();t.TalentUI=e,__reflect(e.prototype,"gui.TalentUI",["INotifier"])}(gui||(gui={}));var gui;!function(t){var e=function(){function t(){}return t.make=function(e){return void 0===e&&(e=3e3),null==t.inst&&(t.inst=new t),t.inst.create(e),t.inst},t.hide=function(){t.inst&&t.inst.onClose()},t.prototype.create=function(t){this._inited||(this._view=fairygui.UIPackage.createObject("tdui1","等待面板").asCom,this._view.setSize(G.width,G.height)),fairygui.GRoot.inst.addChild(this._view),egret.setTimeout(this.onClose,this,t)},t.prototype.onClose=function(){this._view.parent&&this._view.parent.removeChild(this._view)},t}();t.WaittingUI=e,__reflect(e.prototype,"gui.WaittingUI")}(gui||(gui={}));var observer;!function(t){var e=function(){function t(t,e,i){void 0===e&&(e=null),void 0===i&&(i=null),this.name=t,this.body=e,this.callback=i}return t.prototype.toString=function(){var t="Notification Name: "+this.name;return t+="\nBody:"+(null==this.body?"null":this.body),t+="\nType:"+(null==this.type?"null":this.type)},t}();t.Notification=e,__reflect(e.prototype,"observer.Notification")}(observer||(observer={}));var observer;!function(t){var e=function(){function t(){}return t.make=function(e,i){var n=new t;return n.setNotifyMethod(e),n.setNotifyContext(i),n},t.prototype.setNotifyMethod=function(t){this.notify=t},t.prototype.setNotifyContext=function(t){this.context=t},t.prototype.getNotifyMethod=function(){return this.notify},t.prototype.getNotifyContext=function(){return this.context},t.prototype.notifyObserver=function(t){this.getNotifyMethod().apply(this.getNotifyContext(),[t])},t.prototype.compareNotifyContext=function(t){return t===this.context},t}();t.Observer=e,__reflect(e.prototype,"observer.Observer")}(observer||(observer={}));var observer;!function(t){var e=function(){function e(){if(null!=e.instance)throw Error("UI组件管理器已经初始化");e.instance=this,this.mediatorMap=[],this.observerMap=[]}return e.getInstance=function(){return null==this.instance&&(this.instance=new e),this.instance},e.send=function(t,i,n){void 0===i&&(i=null),void 0===n&&(n=null),null==this.instance&&(this.instance=new e),this.instance.sendNotification(t,i,n)},e.prototype.removeAllUI=function(){for(var t in this.mediatorMap){var e=this.mediatorMap[t];if(e){this.mediatorMap[e.getMediatorName()]=null;var i=e.listNotificationInterests();if(i.length>0)for(var n=0;n<i.length;n++)this.removeObserver(i[n],e);e.onRemove()}}this.mediatorMap.length=0},e.prototype.removeUI=function(t){var e=this.mediatorMap[t];if(null!=e){this.mediatorMap[t]=null;var i=e.listNotificationInterests();if(i.length>0)for(var n=0;n<i.length;n++)this.removeObserver(i[n],e);e.onRemove()}},e.prototype.registerUI=function(e){var i=e.getMediatorName();if(null==this.mediatorMap[i]){this.mediatorMap[i]=e;var n=e.listNotificationInterests();if(n.length>0)for(var s=t.Observer.make(e.handleNotification,e),r=0;r<n.length;r++)this.registerObserver(n[r],s);e.onRegister()}},e.prototype.sendNotification=function(e,i,n){void 0===i&&(i=null),void 0===n&&(n=null);var s=new t.Notification(e,i,n);this.notifyObservers(s)},e.prototype.removeObserver=function(t,e){if(null!=this.observerMap[t])for(var i,n=this.observerMap[t],s=0;s<n.length;s++)i=n[s],i.compareNotifyContext(e)&&(n.splice(s,1),s--)},e.prototype.registerObserver=function(t,e){var i=this.observerMap[t];i?i.push(e):this.observerMap[t]=[e]},e.prototype.notifyObservers=function(t){var e=t.name;if(null!=this.observerMap[e]){var i,n=this.observerMap[t.name],s=[],r=void 0;for(r=0;r<n.length;r++)i=n[r],s.push(i);for(r=0;r<s.length;r++)i=s[r],i.notifyObserver(t)}},e}();t.UIManager=e,__reflect(e.prototype,"observer.UIManager")}(observer||(observer={}));var GameScene=function(t){function e(){return t.call(this)||this}return __extends(e,t),e.prototype.initialize=function(){this._initialized||(this._view=fairygui.UIPackage.createObject("tdui1","003 游戏界面").asCom,fairygui.GRoot.inst.addChild(this._view),this._view.setSize(G.width,G.height),this._elpasedTxt=this._view.getChild("n9").asTextField,this._waveTxt=this._view.getChild("n8").asTextField,this._goldTxt=this._view.getChild("n7").asTextField,this._hpTxt=this._view.getChild("n6").asTextField,this._btn=this._view.getChild("btnp").asButton,this._btn.addEventListener(egret.TouchEvent.TOUCH_END,this.onPause,this),this._skbtn1=this._view.getChild("nsk1").asProgress,this._skbtn2=this._view.getChild("nsk2").asProgress,this._skbtn2.value=0,this._skbtn1.addEventListener(egret.TouchEvent.TOUCH_END,this.onSkill,this),this._skbtn2.addEventListener(egret.TouchEvent.TOUCH_END,this.onSkill,this),t.prototype.initialize.call(this),observer.UIManager.getInstance().registerUI(this))},e.prototype.onSkill=function(t){var e=t.currentTarget,i=e.getController("c1");switch(this._lastSK&&(this._lastSK.getController("c1").selectedIndex=0,this._lastSK=null),gui.BuildMenu.hide(),e){case this._skbtn1:1==G.sWorld.cursk?(G.sWorld.cursk=0,i.selectedIndex=0):(G.sWorld.cursk=1,this._lastSK=this._skbtn1,i.selectedIndex=1);break;case this._skbtn2:2==G.sWorld.cursk?(G.sWorld.cursk=0,i.selectedIndex=0):(G.sWorld.cursk=2,i.selectedIndex=1,this._lastSK=this._skbtn2)}},e.prototype.onPause=function(t){var e=this;DyEngine.Engine.getInstance().stop();var i=fairygui.UIPackage.createObject("tdui1","设置界面").asCom;fairygui.GRoot.inst.addChild(i),i.setSize(fairygui.GRoot.inst.width,fairygui.GRoot.inst.height);var n=function(t){fairygui.GRoot.inst.removeChild(i),i.removeEventListener(egret.TouchEvent.TOUCH_END,n,e),DyEngine.Engine.getInstance().start()};i.getChild("btn1").addEventListener(egret.TouchEvent.TOUCH_END,n,this);var s=function(t){fairygui.GRoot.inst.removeChild(i),i.removeEventListener(egret.TouchEvent.TOUCH_END,n,e),G.director.runWithScene(new LevelScene)};i.getChild("btn2").addEventListener(egret.TouchEvent.TOUCH_END,s,this)},e.prototype.show=function(e,i){void 0===e&&(e=null),void 0===i&&(i=null),t.prototype.show.call(this,e,i);var n=DyEngine.Engine.getInstance();n.start(),this._goldTxt.text=String(G.gold),this._waveTxt.text="1/"+G.sWorld.config.data.length,G.bgSoundChancel&&G.bgSoundChancel.stop();var s=new egret.Sound;s.addEventListener(egret.Event.COMPLETE,function(t){G.figMuz=s,G.figSndChancel=s.play()},this),s.load("resource/snd/muz1.mp3"),G.sWorld.addTicker(this.update,this),this._hpTxt.text=String(G.sWorld.home.health)},e.prototype.hide=function(e){void 0===e&&(e=null),t.prototype.hide.call(this,e),G.figSndChancel&&G.figSndChancel.stop(),this._btn.removeEventListener(egret.TouchEvent.TOUCH_END,this.onPause,this),fairygui.GRoot.inst.removeChild(this._view),G.sWorld.clear(),this._view=null,observer.UIManager.getInstance().removeUI(this.getMediatorName())},e.prototype.update=function(){var t=G.sWorld.cd1;if(t>0){var e=this._skbtn1;e.value=t,e.max=5}if(t=G.sWorld.cd2,t>0){var e=this._skbtn2;e.value=t,e.max=15}},e.prototype.getMediatorName=function(){return"GameScene"},e.prototype.listNotificationInterests=function(){return["hurt_home","upd_gold","upd_wave","elpased","casted"]},e.prototype.handleNotification=function(t){switch(t.name){case"hurt_home":this._hpTxt.text=t.body;break;case"upd_gold":this._goldTxt.text=String(G.gold);break;case"upd_wave":var e=G.sWorld;this._waveTxt.text=t.body+"/"+e.config.data.length;break;case"elpased":var i=Math.round(t.body),n=i%60,s=Math.floor(i/60);this._elpasedTxt.text=G.str_pad(String(s),2,"0")+":"+G.str_pad(n.toString(),2,"0");break;case"casted":G.sWorld.cursk=0,this._skbtn1.getController("c1").selectedIndex=0,this._skbtn2.getController("c1").selectedIndex=0}},e.prototype.onRegister=function(){},e.prototype.onRemove=function(){},e}(BaseScene);__reflect(GameScene.prototype,"GameScene",["INotifier"]);var LevelLoadingScene=function(t){function e(){return t.call(this)||this}return __extends(e,t),e.prototype.initialize=function(){this._initialized||(this._view=fairygui.UIPackage.createObject("tduilite","000 开始加载").asCom,fairygui.GRoot.inst.addChild(this._view),this._view.setSize(G.width*G.scale,G.height*G.scale),this._bar=this._view.getChild("n2"),t.prototype.initialize.call(this))},e.prototype.show=function(e,i){void 0===e&&(e=null),void 0===i&&(i=null),egret.log("args",i);var n=i[0];this._mapConfig=n,this.loadResource(n.res),t.prototype.show.call(this,e,i)},e.prototype.loadResource=function(t){return __awaiter(this,void 0,void 0,function(){var e,i,n,s,r,o,a=this;return __generator(this,function(h){switch(h.label){case 0:return h.trys.push([0,2,,3]),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.createGroup("temp",t,!0),[4,RES.loadGroup("temp")];case 1:return h.sent(),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),D.init(),G.initTowerFactory(),e=new core.GameWorld,e.config=this._mapConfig,e.create(),i=DyEngine.Engine.getInstance(),i.state=e,i.addChild(e),"m001"==this._mapConfig.id?(fairygui.UIPackage.addPackage("intro"),n=fairygui.UIPackage.createObject("intro","005 开场漫画").asCom,fairygui.GRoot.inst.addChild(n),n.setSize(fairygui.GRoot.inst.width,fairygui.GRoot.inst.height),n.getChild("n1").asLoader.url="c001_png",s=1,r=function(t){var e=n.getController("c1");1==s&&(n.getChild("n2").asLoader.url="c002_png"),2==s&&(n.getChild("n3").asLoader.url="c003_png"),3==s&&(n.getChild("n2").asLoader.url="",n.getChild("n3").asLoader.url="",n.getChild("n1").asLoader.url="c004_png",e.selectedIndex=1),4==s&&(n.getChild("n2").asLoader.url="c005_png"),5==s&&(n.getChild("n3").asLoader.url="c006_png"),6==s&&(n.getChild("n4").asLoader.url="c007_png",e.selectedIndex=2),s++,s>7&&2==e.selectedIndex&&(fairygui.GRoot.inst.removeChild(n),n.removeEventListener(egret.TouchEvent.TOUCH_END,r,a),G.director.runWithScene(new GameScene))},n.addEventListener(egret.TouchEvent.TOUCH_END,r,this)):G.director.runWithScene(new GameScene),[3,3];case 2:return o=h.sent(),console.error(o),[3,3];case 3:return[2]}})})},e.prototype.onResourceProgress=function(t){this._bar.value=t.itemsLoaded,this._bar.max=t.itemsTotal},e.prototype.hide=function(e){void 0===e&&(e=null),t.prototype.hide.call(this,e),fairygui.GRoot.inst.removeChild(this._view)},e}(BaseScene);__reflect(LevelLoadingScene.prototype,"LevelLoadingScene");var LevelScene=function(t){function e(){return t.call(this)||this}return __extends(e,t),e.prototype.initialize=function(){this._initialized||(this._view=fairygui.UIPackage.createObject("tdui1","002 大地图").asCom,fairygui.GRoot.inst.addChild(this._view),this._view.setSize(G.width,G.height),this._btn2=this._view.getChild("n53").asButton,this._btn2.addEventListener(egret.TouchEvent.TOUCH_END,this.onClick,this),this._btn3=this._view.getChild("n49").asButton,this._btn3.addEventListener(egret.TouchEvent.TOUCH_END,this.onClick,this),this._btn4=this._view.getChild("n45").asButton,this._btn4.addEventListener(egret.TouchEvent.TOUCH_END,this.onClick,this),this._btn5=this._view.getChild("n62").asButton,this._btn5.addEventListener(egret.TouchEvent.TOUCH_END,this.onClick,this),this._tfscore=this._view.getChild("n52").asTextField,t.prototype.initialize.call(this))},e.prototype.onClick=function(t){var e,i=this;switch(t.currentTarget){case this._btn2:e=new gui.RankUI;break;case this._btn3:e=new gui.ShopUI;break;case this._btn4:e=new gui.TalentUI;break;case this._btn5:var n=fairygui.UIPackage.createObject("tdui1","广告确认面板").asCom;fairygui.GRoot.inst.addChild(n);var s=n.getChild("b1").asButton,r=n.getChild("b2").asButton,o=function(t){fairygui.GRoot.inst.removeChild(n);var e=window.h5api;e&&(gui.WaittingUI.make(),e.playAd(function(t){if(gui.WaittingUI.hide(),console.log("代码:"+t.code+",消息:"+t.message),1e4===t.code)console.log("开始播放");else if(10001===t.code){console.log("播放结束"),G.sd.ddb+=20;var e=DyEngine.DyMath.toNumber(G.sd.tt);e++,10>e&&(G.sd.tt=e),observer.UIManager.send("upd_gold")}else console.log("广告异常")}),s.removeEventListener(egret.TouchEvent.TOUCH_END,o,i))},a=function(t){fairygui.GRoot.inst.removeChild(n),r.removeEventListener(egret.TouchEvent.TOUCH_END,a,i)};s.addEventListener(egret.TouchEvent.TOUCH_END,o,this),r.addEventListener(egret.TouchEvent.TOUCH_END,a,this)}},e.prototype.show=function(e,i){void 0===e&&(e=null),void 0===i&&(i=null),t.prototype.show.call(this,e,i),G.bgSoundChancel&&G.bgSoundChancel.stop(),G.bgMuz&&(G.bgSoundChancel=G.bgMuz.play(0,1)),this._tfscore.text=String(DyEngine.DyMath.toNumber(G.sd.score));var n=window.h5api,s=DyEngine.DyMath.toNumber(G.sd.tt);egret.log("ads:",n,s),n&&n.canPlayAd()&&10>s?this._btn5.visible=!0:this._btn5.visible=!1},e.prototype.hide=function(e){void 0===e&&(e=null),t.prototype.hide.call(this,e),fairygui.GRoot.inst.removeChild(this._view),this._btn2.removeEventListener(egret.TouchEvent.TOUCH_END,this.onClick,this),this._btn3.removeEventListener(egret.TouchEvent.TOUCH_END,this.onClick,this),this._btn4.removeEventListener(egret.TouchEvent.TOUCH_END,this.onClick,this),this._btn5.removeEventListener(egret.TouchEvent.TOUCH_END,this.onClick,this)},e}(BaseScene);__reflect(LevelScene.prototype,"LevelScene");var LoadingScene=function(t){function e(){return t.call(this)||this}return __extends(e,t),e.prototype.initialize=function(){this._initialized||(this._view=fairygui.UIPackage.createObject("tduilite","000 开始加载").asCom,fairygui.GRoot.inst.addChild(this._view),this._view.setSize(G.width,G.height),this._bar=this._view.getChild("n2"),t.prototype.initialize.call(this))},e.prototype.show=function(e,i){void 0===e&&(e=null),void 0===i&&(i=null),egret.log("args",i),this.loadResource(i),t.prototype.show.call(this,e,i)},e.prototype.loadResource=function(t){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,RES.loadGroup("uiall",0,this._bar)];case 1:return e.sent(),fairygui.UIPackage.addPackage("tdui"),fairygui.UIObjectFactory.setPackageItemExtension(gui.LevelPort.url,gui.LevelPort),fairygui.UIObjectFactory.setPackageItemExtension(gui.BuildMenu.url,gui.BuildMenu),fairygui.UIObjectFactory.setPackageItemExtension(gui.shopCell.url,gui.shopCell),fairygui.UIObjectFactory.setPackageItemExtension(gui.talentCell.url,gui.talentCell),D.initmap(),G.director.runWithCache("map",LevelScene),core.DataMgr.init(),[3,3];case 2:return t=e.sent(),console.error(t),[3,3];case 3:return[2]}})})},e.prototype.hide=function(e){void 0===e&&(e=null),t.prototype.hide.call(this,e),fairygui.GRoot.inst.removeChild(this._view)},e}(BaseScene);__reflect(LoadingScene.prototype,"LoadingScene");var MainMenu=function(t){function e(){return t.call(this)||this}return __extends(e,t),e.prototype.initialize=function(){if(!this._initialized){this._view=fairygui.UIPackage.createObject("tduilite","001 封面").asCom,fairygui.GRoot.inst.addChild(this._view),this._view.setSize(G.width,G.height),t.prototype.initialize.call(this);var e=this._view.getChild("btnstart").asButton;e.addClickListener(this.onStart,this);var i=this._view.getChild("btninfo").asButton;i.addClickListener(this.onTuorial,this)}},e.prototype.onTuorial=function(t){var e=this,i=fairygui.UIPackage.createObject("tduilite","005 玩法说明").asCom;fairygui.GRoot.inst.addChild(i),i.setSize(G.width,G.height);var n=function(t){fairygui.GRoot.inst.removeChild(i),i.removeEventListener(egret.TouchEvent.TOUCH_END,n,e)};i.addEventListener(egret.TouchEvent.TOUCH_END,n,this),G.onceSnd("openui")},e.prototype.onStart=function(t){G.bgMuz&&null==G.bgSoundChancel&&(G.bgSoundChancel=G.bgMuz.play(0,1)),G.onceSnd("close"),G.director.runWithScene(new LoadingScene,["main"])},e.prototype.show=function(e,i){void 0===e&&(e=null),void 0===i&&(i=null),t.prototype.show.call(this,e,i),G.bgSoundChancel&&(G.bgSoundChancel.stop(),G.bgMuz=null,G.bgSoundChancel=null);var n=new egret.Sound;n.addEventListener(egret.Event.COMPLETE,function(t){G.bgMuz=n},this),n.load("resource/snd/muz.mp3"),G.resLoaded&&(this._view.getChild("n3").visible=!0)},e.prototype.loadResource=function(){return __awaiter(this,void 0,void 0,function(){var t,e,i;return __generator(this,function(n){switch(n.label){case 0:return n.trys.push([0,3,,4]),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.createGroup("temp",["level1_png"]),[4,RES.loadGroup("temp")];case 1:return n.sent(),t=new egret.Bitmap,e=RES.getRes("level1_png"),t.texture=e,fairygui.GRoot.inst.displayListContainer.addChild(t),[4,RES.destroyRes("temp")];case 2:return n.sent(),[3,4];case 3:return i=n.sent(),console.error(i),[3,4];case 4:return[2]}})})},e.prototype.onResourceProgress=function(t){egret.log(t.data,t.itemsLoaded,"/",t.itemsTotal)},e.prototype.hide=function(e){void 0===e&&(e=null),t.prototype.hide.call(this,e),fairygui.GRoot.inst.removeChild(this._view)},e}(BaseScene);__reflect(MainMenu.prototype,"MainMenu");var utils;!function(t){var e=function(){function t(){}return t.prototype.create=function(t){var e;null==this.view?this.view=fairygui.UIPackage.createObject("tdui1","建造进度").asProgress:e=this.view,this.exists=!0,fairygui.GRoot.inst.addChild(this.view),this.parent=t,this.view.x=this.parent.x,this.view.y=this.parent.y},t.prototype.kill=function(){fairygui.GRoot.inst.removeChild(this.view),this.exists=!1},t.make=function(e,i,n){var s=t.getAvail();return null==s&&(s=new t,t.members.push(s)),s.create(e),s},t.getAvail=function(){for(var e,i=t.members.length,n=0;i>n;){if(e=t.members[n],null!=e&&!e.exists)return e;n++}return null},t.prototype.update=function(t,e){this.parent&&(this.view.value=t,this.view.max=e)},t.members=[],t}();t.BuildBar=e,__reflect(e.prototype,"utils.BuildBar")}(utils||(utils={}));var utils;!function(t){var e=function(){function t(){}return t.prototype.create=function(t){var e;null==this.view?this.view=fairygui.UIPackage.createObject("tdui1","怪血").asProgress:e=this.view,this.exists=!0,fairygui.GRoot.inst.addChild(this.view),this.parent=t,this.view.x=this.parent.x-12,this.view.y=this.parent.y-30},t.prototype.kill=function(){fairygui.GRoot.inst.removeChild(this.view),this.exists=!1},t.make=function(e,i,n){var s=t.getAvail();return null==s&&(s=new t,t.members.push(s)),s.create(e),s},t.getAvail=function(){for(var e,i=t.members.length,n=0;i>n;){if(e=t.members[n],null!=e&&!e.exists)return e;n++}return null},t.prototype.update=function(){this.parent&&(this.view.x=this.parent.x-12,this.view.y=this.parent.y-30,this.view.value=this.parent.health,this.view.max=this.parent.hpmax)},t.members=[],t}();t.EffectBar=e,__reflect(e.prototype,"utils.EffectBar")}(utils||(utils={}));var utils;!function(t){var e=function(){function t(){}return t.prototype.create=function(t,e,i){var n,s=this;if(null==this.clip){var r=RES.getRes(e+"_png"),o=RES.getRes(e+"_json"),a=new egret.MovieClipDataFactory(o,r);n=new egret.MovieClip(a.generateMovieClipData(i)),n.touchEnabled=!1,this.key=e+"_"+i,this.clip=n}else n=this.clip;this.exists=!0,n.gotoAndPlay(1),n.once(egret.Event.COMPLETE,function(t){s.kill()},this),t.addChild(n),this.parent=t},t.prototype.kill=function(){this.parent.removeChild(this.clip),this.clip.stop(),this.exists=!1},t.make=function(e,i,n,s,r){var o=t.getAvail(i+"_"+n);return null==o&&(o=new t,t.members.push(o)),o.create(e,i,n),o.clip.x=s,o.clip.y=r,o},t.getAvail=function(e){for(var i,n=t.members.length,s=0;n>s;){if(i=t.members[s],null!=i&&!i.exists&&i.key==e)return i;s++}return null},t.members=[],t}();t.EffectClip=e,__reflect(e.prototype,"utils.EffectClip")}(utils||(utils={}));var utils;!function(t){var e=function(){function t(){}return t.prototype.create=function(t,e){var i=this;null==this.view&&(this.view=fairygui.UIPackage.createObject("tdui1","伤害数字").asCom,this._tf=this.view.getChild("n0").asTextField,this._t0=this.view.getTransition("t0")),this.exists=!0,this._tf.text="-"+e,fairygui.GRoot.inst.addChild(this.view),this._t0.play(function(){i.kill()}),this.parent=t,this.view.x=this.parent.x,this.view.y=this.parent.y},t.prototype.kill=function(){fairygui.GRoot.inst.removeChild(this.view),this.exists=!1},t.make=function(e,i,n,s){void 0===n&&(n=0),void 0===s&&(s=0);var r=t.getAvail();return null==r&&(r=new t,t.members.push(r)),r.create(e,i),r},t.getAvail=function(){for(var e,i=t.members.length,n=0;i>n;){if(e=t.members[n],null!=e&&!e.exists)return e;n++}return null},t.members=[],t}();t.EffectDmg=e,__reflect(e.prototype,"utils.EffectDmg")}(utils||(utils={}));var utils;!function(t){var e=function(){function t(){this.type=0,this.completed=!1,this.events=new DyEngine.DyEvent}return t.prototype.create=function(t,e,i,n){var s,r=this;if(null==this.clip){var o=RES.getRes(i+"_png"),a=RES.getRes(i+"_json"),h=new egret.MovieClipDataFactory(a,o);s=new egret.MovieClip(h.generateMovieClipData(n)),s.touchEnabled=!1,this.key=i+"_"+n,this.clip=s}else s=this.clip;this.events.clean(),this.completed=!1,this.exists=!0,s.gotoAndPlay(1),s.alpha=1,s.addEventListener(egret.Event.ENTER_FRAME,this.onUpdate,this),s.once(egret.Event.COMPLETE,function(t){r.events.send("end",r),r.type>0&&r.kill(),r.completed=!0},this),G.sWorld.addChild(s)},t.prototype.onUpdate=function(){var t=this.clip.currentFrameLabel;if(t){var e=t.split(":");this.events.send("onlab",e[0],e[1])}0==this.type?(this.clip.y-=3,this.completed&&(this.clip.alpha-=.05,this.clip.alpha<=0&&this.kill())):this.completed&&this.kill()},t.prototype.kill=function(){G.sWorld.removeChild(this.clip),this.clip.stop(),this.clip.removeEventListener(egret.Event.ENTER_FRAME,this.onUpdate,this),this.exists=!1,this.events.clean()
},t.make=function(e,i,n,s){var r=t.getAvail(e+"_"+i);return null==r&&(r=new t,t.members.push(r)),r.create(n,s,e,i),r.clip.x=n,r.clip.y=s,r},t.getAvail=function(e){for(var i,n=t.members.length,s=0;n>s;){if(i=t.members[s],null!=i&&!i.exists&&i.key==e)return i;s++}return null},t.members=[],t}();t.EffectFlash=e,__reflect(e.prototype,"utils.EffectFlash")}(utils||(utils={}));var utils;!function(t){var e=function(t){function e(){return t.call(this)||this}return __extends(e,t),e.prototype.create=function(){this.exists=!0;var t=this.graphics;t.clear(),t.beginFill(0,.3),t.lineStyle(.1,13421772),t.drawCircle(0,0,this.range),t.endFill(),this.touchEnabled=!1},e.make=function(t,i,n){var s=e.inst;return null==s&&(s=new e,e.inst=s),s.range=t,s.create(),s.x=i,s.y=n,G.sWorld.addChild(s),s},e.hide=function(){var t=e.inst;G.sWorld.contains(t)&&G.sWorld.removeChild(t)},e}(egret.Shape);t.EffectRange=e,__reflect(e.prototype,"utils.EffectRange")}(utils||(utils={}));